#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."
echo ""

# Backend ESLint (staged files only)
BACKEND_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^backend/.*\.(ts|tsx)$' || true)

if [ -n "$BACKEND_FILES" ]; then
  echo "üßπ Running backend ESLint on staged files..."

  # Convert full paths to relative paths from backend directory
  RELATIVE_FILES=$(echo "$BACKEND_FILES" | sed 's|^backend/||')

  # Run ESLint from backend directory
  cd backend && npx eslint $RELATIVE_FILES
  ESLINT_EXIT=$?
  cd ..

  if [ $ESLINT_EXIT -ne 0 ]; then
    echo ""
    echo "‚ùå Backend ESLint failed on staged files."
    echo "üí° This includes the SQL NULL comparison check."
    echo "   Fix the errors and try again."
    exit 1
  fi
  echo "‚úÖ Backend ESLint passed"
else
  echo "‚è≠Ô∏è  No staged backend files to lint"
fi

# Frontend ESLint (staged files only)
FRONTEND_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^frontend/.*\.(ts|tsx)$' || true)

if [ -n "$FRONTEND_FILES" ]; then
  echo ""
  echo "üßπ Running frontend ESLint on staged files..."

  # Convert full paths to relative paths from frontend directory
  RELATIVE_FILES=$(echo "$FRONTEND_FILES" | sed 's|^frontend/||')

  # Run ESLint from frontend directory
  cd frontend && npx eslint $RELATIVE_FILES
  ESLINT_EXIT=$?
  cd ..

  if [ $ESLINT_EXIT -ne 0 ]; then
    echo ""
    echo "‚ùå Frontend ESLint failed on staged files."
    echo "   Fix the errors and try again."
    exit 1
  fi
  echo "‚úÖ Frontend ESLint passed"
else
  echo "‚è≠Ô∏è  No staged frontend files to lint"
fi

echo ""
echo "‚úÖ Pre-commit checks passed. Committing..."
