#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."
echo ""

# Backend ESLint (staged files only)
BACKEND_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^backend/.*\.(ts|tsx)$' || true)

if [ -n "$BACKEND_FILES" ]; then
  echo "üßπ Running backend ESLint on staged files..."
  echo "$BACKEND_FILES" | while read -r file; do
    if [ -n "$file" ] && [ -f "$file" ]; then
      # Run ESLint on each file from repo root
      npx eslint "$file"
      if [ $? -ne 0 ]; then
        echo ""
        echo "‚ùå Backend ESLint failed on: $file"
        echo "üí° This includes the SQL NULL comparison check."
        echo "   Fix the errors and try again."
        exit 1
      fi
    fi
  done
  echo "‚úÖ Backend ESLint passed"
else
  echo "‚è≠Ô∏è  No staged backend files to lint"
fi

# Frontend ESLint (staged files only)
FRONTEND_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^frontend/.*\.(ts|tsx)$' || true)

if [ -n "$FRONTEND_FILES" ]; then
  echo ""
  echo "üßπ Running frontend ESLint on staged files..."
  echo "$FRONTEND_FILES" | while read -r file; do
    if [ -n "$file" ] && [ -f "$file" ]; then
      # Run ESLint on each file from repo root
      npx eslint "$file"
      if [ $? -ne 0 ]; then
        echo ""
        echo "‚ùå Frontend ESLint failed on: $file"
        echo "   Fix the errors and try again."
        exit 1
      fi
    fi
  done
  echo "‚úÖ Frontend ESLint passed"
else
  echo "‚è≠Ô∏è  No staged frontend files to lint"
fi

echo ""
echo "‚úÖ Pre-commit checks passed. Committing..."
