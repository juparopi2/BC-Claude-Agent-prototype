#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-push checks..."
echo ""

# Backend linting
echo "ğŸ§¹ Running backend linter..."
cd backend && npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Backend linting failed. Push aborted."
  exit 1
fi

# Backend unit tests
echo ""
echo "ğŸ§ª Running backend unit tests..."
npm test
if [ $? -ne 0 ]; then
  echo "âŒ Backend unit tests failed. Push aborted."
  exit 1
fi

# Backend integration tests
echo ""
echo "ğŸ”— Running backend integration tests..."

# Check if Docker is available
if command -v docker >/dev/null 2>&1; then
  # Check if Redis test container is running
  if ! docker ps --format '{{.Names}}' | grep -q 'bc-agent-redis-test'; then
    echo "ğŸ³ Starting Redis test container..."
    docker-compose -f docker-compose.test.yml up -d

    # Wait for Redis to be ready
    echo "â³ Waiting for Redis to be ready..."
    timeout=30
    while [ $timeout -gt 0 ]; do
      if docker exec bc-agent-redis-test redis-cli ping >/dev/null 2>&1; then
        echo "âœ… Redis is ready"
        break
      fi
      sleep 1
      timeout=$((timeout - 1))
    done

    if [ $timeout -eq 0 ]; then
      echo "âš ï¸  Redis container failed to start. Integration tests may fail."
    fi

    STARTED_REDIS=true
  else
    echo "âœ… Redis test container already running"
    STARTED_REDIS=false
  fi
else
  echo "âš ï¸  Docker not available. Using existing Redis (if configured)."
  STARTED_REDIS=false
fi

npm run test:integration
INTEGRATION_RESULT=$?

# Clean up Redis container if we started it
if [ "$STARTED_REDIS" = true ]; then
  echo "ğŸ§¹ Stopping Redis test container..."
  docker-compose -f docker-compose.test.yml down >/dev/null 2>&1
fi

if [ $INTEGRATION_RESULT -ne 0 ]; then
  echo "âŒ Backend integration tests failed. Push aborted."
  exit 1
fi

# Backend build
echo ""
echo "ğŸ—ï¸  Building backend..."
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Backend build failed. Push aborted."
  exit 1
fi

# Frontend linting
echo ""
echo "ğŸ§¹ Running frontend linter..."
cd ../frontend && npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Frontend linting failed. Push aborted."
  exit 1
fi

# Frontend tests
echo ""
echo "ğŸ§ª Running frontend tests..."
npm test
if [ $? -ne 0 ]; then
  echo "âŒ Frontend tests failed. Push aborted."
  exit 1
fi

# Frontend build
echo ""
echo "ğŸ—ï¸  Building frontend..."
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Frontend build failed. Push aborted."
  exit 1
fi

echo ""
echo "âœ… All checks passed. Pushing..."
