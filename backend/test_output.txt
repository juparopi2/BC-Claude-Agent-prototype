
> bc-claude-agent-backend@1.0.0 test
> vitest run


[1m[7m[36m RUN [39m[27m[22m [36mv2.1.8 [39m[90mD:/Documents/BC-Claude-Agent-prototype/backend[39m

 [32mΓ£ô[39m src/__tests__/unit/services/agent/AnthropicClient.test.ts [2m([22m[2m52 tests[22m[2m)[22m[90m 151[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2msession validation[2m > [22m[2mshould return 401 when session is undefined
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mfalse[39m,
  sessionKeys: [],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft failed: No session or microsoftOAuth { hasSession: [33mfalse[39m, hasMicrosoftOAuth: [33mfalse[39m, sessionId: [90mundefined[39m }

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2msession validation[2m > [22m[2mshould return 401 when microsoftOAuth is undefined
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft failed: No session or microsoftOAuth { hasSession: [33mtrue[39m, hasMicrosoftOAuth: [33mfalse[39m, sessionId: [90mundefined[39m }

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2msession validation[2m > [22m[2mshould return 401 when userId is missing
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2msession validation[2m > [22m[2mshould return 401 when microsoftId is missing
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2msession validation[2m > [22m[2mshould return 401 when accessToken is missing
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2mvalid session[2m > [22m[2mshould attach session data to request and call next() for valid session
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-123'[39m,
  email: [32m'test@example.com'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2mvalid session[2m > [22m[2mshould work with session without tokenExpiresAt (non-expiring)
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-123'[39m,
  email: [32m'test@example.com'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2mtoken expiration and refresh[2m > [22m[2mshould return 401 when token is expired and no refreshToken
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2mtoken expiration and refresh[2m > [22m[2mshould refresh token when expired and refreshToken is available
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2mtoken expiration and refresh[2m > [22m[2mshould return 401 when token refresh fails
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2merror handling[2m > [22m[2mshould return 500 on unexpected errors during session.save
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2merror handling[2m > [22m[2mshould handle request without path or method gracefully
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [90mundefined[39m,
  method: [90mundefined[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft failed: No session or microsoftOAuth { hasSession: [33mtrue[39m, hasMicrosoftOAuth: [33mfalse[39m, sessionId: [90mundefined[39m }

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2mtoken expiration boundary cases[2m > [22m[2mshould treat token as expired when tokenExpiresAt equals current time
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2mtoken expiration boundary cases[2m > [22m[2mshould accept token expiring 1ms in the future
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2moptional field handling[2m > [22m[2mshould work with undefined displayName
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-123'[39m,
  email: [32m'test@example.com'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2moptional field handling[2m > [22m[2mshould work with empty string displayName
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-123'[39m,
  email: [32m'test@example.com'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2memail validation edge cases[2m > [22m[2mshould accept valid email formats
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-123'[39m,
  email: [32m'test@example.com'[39m
}
[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-123'[39m,
  email: [32m'user.name+tag@domain.co.uk'[39m
}
[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-123'[39m,
  email: [32m'user@sub.domain.org'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2memail validation edge cases[2m > [22m[2mshould handle email with special characters (stored as-is from Microsoft)
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-123'[39m,
  email: [32m'user@example.com'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2memail validation edge cases[2m > [22m[2mshould handle undefined email
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-123'[39m,
  email: [90mundefined[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mauthenticateMicrosoft[2m > [22m[2mmulti-tenant isolation[2m > [22m[2mshould correctly scope session to specific userId
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-1'[39m,
  email: [32m'user1@example.com'[39m
}
[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-2'[39m,
  email: [32m'user2@example.com'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mSession Security[2m > [22m[2msession fixation protection[2m > [22m[2mshould not leak session data between different session IDs
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'id'[39m, [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'victim-user-id'[39m,
  email: [32m'victim@example.com'[39m
}

 [32mΓ£ô[39m src/__tests__/unit/services/files/FileService.test.ts [2m([22m[2m36 tests[22m[2m)[22m[90m 89[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mSession Security[2m > [22m[2msession isolation[2m > [22m[2mshould not share state between requests
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-1'[39m,
  email: [32m'test@example.com'[39m
}
[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}
[E2E-DEBUG] authenticateMicrosoft SUCCESS: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  userId: [32m'user-2'[39m,
  email: [32m'test@example.com'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mToken Refresh Race Condition (Documented)[2m > [22m[2mshould document that concurrent refresh may cause race condition
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}

[90mstdout[2m | src/__tests__/unit/middleware/auth-oauth.test.ts[2m > [22m[2mToken Refresh Race Condition (Documented)[2m > [22m[2mshould document that concurrent refresh may cause race condition
[22m[39m[E2E-DEBUG] authenticateMicrosoft called: {
  path: [32m'/api/test'[39m,
  method: [32m'GET'[39m,
  hasSession: [33mtrue[39m,
  sessionKeys: [ [32m'save'[39m, [32m'microsoftOAuth'[39m ],
  hasCookie: [33mfalse[39m,
  cookieHeader: [32m'undefined...'[39m
}

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandle() - Basic Message Handling[2m > [22m[2mshould validate session ownership before processing
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandle() - Basic Message Handling[2m > [22m[2mshould save user message with userId audit trail
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandle() - Basic Message Handling[2m > [22m[2mshould execute agent query via DirectAgentService
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandle() - Basic Message Handling[2m > [22m[2mshould emit error event on failure
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandleAgentEvent() - Event Discrimination[2m > [22m[2mshould handle session_start event (no persistence)
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: session_start, Session: test-session-123, Seq: 1

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandleAgentEvent() - Event Discrimination[2m > [22m[2mshould handle message_partial event (no persistence)
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: message_partial, Session: test-session-123, Seq: 3

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandleAgentEvent() - Event Discrimination[2m > [22m[2mshould handle message_chunk event (no persistence)
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: message_chunk, Session: test-session-123, Seq: 4
[SOCKET_EMIT] MESSAGE_CHUNK: {
  "type": "message_chunk",
  "content": "chunk of text",
  "timestamp": "2025-12-11T20:07:31.679Z",
  "eventId": "evt-4",
  "sequenceNumber": 4,
  "persistenceState": "queued"
}

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandleAgentEvent() - Event Discrimination[2m > [22m[2mshould handle tool_use event with valid toolUseId
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: tool_use, Session: test-session-123, Seq: 6
[SOCKET_EMIT] TOOL_USE DETECTED: {
  "type": "tool_use",
  "toolName": "list_all_entities",
  "args": {
    "entity": "customer"
  },
  "toolUseId": "tool-456",
  "timestamp": "2025-12-11T20:07:31.684Z",
  "eventId": "evt-6",
  "sequenceNumber": 6,
  "persistenceState": "queued"
}

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandleAgentEvent() - Event Discrimination[2m > [22m[2mshould skip tool_use event with missing toolUseId
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: tool_use, Session: test-session-123, Seq: 7
[SOCKET_EMIT] TOOL_USE DETECTED: {
  "type": "tool_use",
  "toolName": "list_all_entities",
  "args": {
    "entity": "customer"
  },
  "timestamp": "2025-12-11T20:07:31.687Z",
  "eventId": "evt-7",
  "sequenceNumber": 7,
  "persistenceState": "queued"
}

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandleAgentEvent() - Event Discrimination[2m > [22m[2mshould handle tool_result event
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: tool_result, Session: test-session-123, Seq: 8

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandleAgentEvent() - Event Discrimination[2m > [22m[2mshould detect TodoWrite tool (no additional persistence)
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: tool_use, Session: test-session-123, Seq: 9
[SOCKET_EMIT] TOOL_USE DETECTED: {
  "type": "tool_use",
  "toolName": "TodoWrite",
  "args": {
    "todos": [
      {
        "content": "Task 1",
        "activeForm": "Doing Task 1",
        "status": "pending"
      },
      {
        "content": "Task 2",
        "activeForm": "Doing Task 2",
        "status": "pending"
      }
    ]
  },
  "toolUseId": "tool-789",
  "timestamp": "2025-12-11T20:07:31.694Z",
  "eventId": "evt-9",
  "sequenceNumber": 9,
  "persistenceState": "queued"
}

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandleAgentEvent() - Event Discrimination[2m > [22m[2mshould handle session_end event (no persistence)
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: session_end, Session: test-session-123, Seq: 10

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandleAgentEvent() - Event Discrimination[2m > [22m[2mshould handle complete event
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: complete, Session: test-session-123, Seq: 11

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandleAgentEvent() - Event Discrimination[2m > [22m[2mshould handle approval_requested event (no persistence)
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: approval_requested, Session: test-session-123, Seq: 12

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandleAgentEvent() - Event Discrimination[2m > [22m[2mshould handle approval_resolved event (no persistence)
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: approval_resolved, Session: test-session-123, Seq: 13

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mhandleAgentEvent() - Event Discrimination[2m > [22m[2mshould handle error event
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: error, Session: test-session-123, Seq: 14

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mMessage Ordering & Race Conditions[2m > [22m[2mshould preserve event order via sequenceNumber
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
≡ƒôí [ChatMessageHandler] Relaying thinking event to Socket.IO: {
  sessionId: [32m'test-session-123'[39m,
  eventType: [32m'thinking'[39m,
  sequenceNumber: [33m1[39m,
  eventId: [32m'evt-1'[39m
}
[SOCKET_EMIT] Type: thinking, Session: test-session-123, Seq: 1
Γ£à [ChatMessageHandler] Thinking event emitted to Socket.IO room: test-session-123
[SOCKET_EMIT] Type: message_chunk, Session: test-session-123, Seq: 2
[SOCKET_EMIT] MESSAGE_CHUNK: {
  "type": "message_chunk",
  "content": "Second event",
  "timestamp": "2025-12-11T20:07:31.706Z",
  "eventId": "evt-2",
  "sequenceNumber": 2,
  "persistenceState": "queued"
}
[SOCKET_EMIT] Type: message, Session: test-session-123, Seq: 3

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mMessage Ordering & Race Conditions[2m > [22m[2mshould handle concurrent events without race conditions
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: tool_use, Session: test-session-123, Seq: 1
[SOCKET_EMIT] TOOL_USE DETECTED: {
  "type": "tool_use",
  "toolName": "tool1",
  "args": {},
  "toolUseId": "tool-1",
  "timestamp": "2025-12-11T20:07:31.710Z",
  "eventId": "evt-1",
  "sequenceNumber": 1,
  "persistenceState": "queued"
}
[SOCKET_EMIT] Type: tool_use, Session: test-session-123, Seq: 2
[SOCKET_EMIT] TOOL_USE DETECTED: {
  "type": "tool_use",
  "toolName": "tool2",
  "args": {},
  "toolUseId": "tool-2",
  "timestamp": "2025-12-11T20:07:31.710Z",
  "eventId": "evt-2",
  "sequenceNumber": 2,
  "persistenceState": "queued"
}

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mMessage Ordering & Race Conditions[2m > [22m[2mshould maintain order between tool_use and tool_result
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: tool_use, Session: test-session-123, Seq: 1
[SOCKET_EMIT] TOOL_USE DETECTED: {
  "type": "tool_use",
  "toolName": "list_all_entities",
  "args": {
    "entity": "customer"
  },
  "toolUseId": "tool-123",
  "timestamp": "2025-12-11T20:07:31.715Z",
  "eventId": "evt-1",
  "sequenceNumber": 1,
  "persistenceState": "queued"
}
[SOCKET_EMIT] Type: tool_result, Session: test-session-123, Seq: 2

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mMessage Ordering & Race Conditions[2m > [22m[2mshould emit events to correct session room (no cross-session leaks)
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
≡ƒôí [ChatMessageHandler] Relaying thinking event to Socket.IO: {
  sessionId: [32m'test-session-123'[39m,
  eventType: [32m'thinking'[39m,
  sequenceNumber: [33m1[39m,
  eventId: [32m'evt-1'[39m
}
[SOCKET_EMIT] Type: thinking, Session: test-session-123, Seq: 1
Γ£à [ChatMessageHandler] Thinking event emitted to Socket.IO room: test-session-123

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mWebSocket Emission[2m > [22m[2mshould emit agent:event to correct session room
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: message, Session: test-session-123, Seq: 1

[90mstdout[2m | src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts[2m > [22m[2mChatMessageHandler[2m > [22m[2mAudit Trail[2m > [22m[2mshould include userId in all log statements
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'test-user-456'[39m },
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'test-session-123'[39m,
  userId: [32m'test-user-456'[39m
}
[SOCKET_EMIT] Type: tool_use, Session: test-session-123, Seq: 1
[SOCKET_EMIT] TOOL_USE DETECTED: {
  "type": "tool_use",
  "toolName": "list_all_entities",
  "args": {},
  "toolUseId": "tool-123",
  "timestamp": "2025-12-11T20:07:31.723Z",
  "eventId": "evt-1",
  "sequenceNumber": 1,
  "persistenceState": "queued"
}

 [31mΓ¥»[39m src/__tests__/unit/services/websocket/ChatMessageHandler.test.ts [2m([22m[2m22 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[90m 98[2mms[22m[39m
[31m   [31m├ù[31m ChatMessageHandler[2m > [22mhandle() - Basic Message Handling[2m > [22mshould execute agent query via DirectAgentService[90m 14[2mms[22m[31m[39m
[31m     ΓåÆ expected "spy" to be called with arguments: [ 'Hello, agent!', ΓÇª(4) ][90m

Received: 

[1m  1st spy call:

[22m[2m  Array [[22m
[2m    "Hello, agent!",[22m
[2m    "test-session-123",[22m
[32m-   Any<Function>,[90m
[31m+   [Function anonymous],[90m
[2m    "test-user-456",[22m
[32m-   undefined,[90m
[31m+   Object {[90m
[31m+     "attachments": undefined,[90m
[31m+   },[90m
[2m  ][22m
[31m[90m

Number of calls: [1m1[22m
[31m[39m
 [32mΓ£ô[39m src/__tests__/unit/middleware/auth-oauth.test.ts [2m([22m[2m48 tests[22m[2m)[22m[33m 343[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/ApprovalManager.test.ts [2m([22m[2m34 tests[22m[2m)[22m[90m 113[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/billing/BillingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: Γ£à audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ≡ƒöæ add access controls to secrets: https://dotenvx.com/ops

 [32mΓ£ô[39m src/__tests__/unit/server.comprehensive.test.ts [2m([22m[2m35 tests[22m[2m)[22m[33m 1549[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/routes/token-usage.routes.test.ts [2m([22m[2m49 tests[22m[2m)[22m[33m 1745[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/routes/server-endpoints.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 2073[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/routes/logs.routes.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 1873[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/routes/auth-oauth.routes.test.ts [2m([22m[2m50 tests[22m[2m)[22m[33m 2013[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/billing/BillingService.test.ts [2m([22m[2m33 tests[22m[2m)[22m[90m 57[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/middleware/logging.test.ts [2m([22m[2m36 tests[22m[2m)[22m[90m 30[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/auth/BCTokenManager.test.ts [2m([22m[2m30 tests[22m[2m)[22m[90m 53[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/security/websocket-multi-tenant.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 2591[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/bc/BCClient.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 843[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/tracking/UsageAggregationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | src/__tests__/unit/services/tracking/QuotaValidatorService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mlist_all_entities[2m > [22m[2mshould list all entities without filters
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483655116
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-list'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:35.363 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-list"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:35.364 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-list"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/services/messages/MessageService.test.ts [2m([22m[2m19 tests[22m[2m)[22m[90m 59[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/events/EventStore.test.ts [2m([22m[2m40 tests[22m[2m)[22m[90m 121[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/tracking/QuotaValidatorService.test.ts [2m([22m[2m37 tests[22m[2m)[22m[90m 165[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould execute simple query without tools
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=60
[STREAM] content_block_stop (text): index=0, text_len=60, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=15
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m15[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m115[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-123'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould execute query with tool use (list_all_entities)
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483655878
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-tool'[39m,
  turnCount: [33m1[39m
}

 [32mΓ£ô[39m src/__tests__/unit/services/files/FileProcessingService.test.ts [2m([22m[2m29 tests[22m[2m)[22m[90m 117[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/BCValidator.test.ts [2m([22m[2m59 tests[22m[2m)[22m[90m 106[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/tracking/UsageAggregationService.test.ts [2m([22m[2m28 tests[22m[2m)[22m[90m 160[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/files/processors/DocxProcessor.test.ts [2m([22m[2m21 tests[22m[2m)[22m[90m 67[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/files/processors/PdfProcessor.test.ts [2m([22m[2m19 tests[22m[2m)[22m[90m 100[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/auth/MicrosoftOAuthService.test.ts [2m([22m[2m33 tests[22m[2m)[22m[90m 213[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/agent/messages/ContentBlockAccumulator.test.ts [2m([22m[2m34 tests[22m[2m)[22m[90m 67[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mlist_all_entities[2m > [22m[2mshould list all entities without filters
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=16
[STREAM] content_block_stop (text): index=0, text_len=16, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m34[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m254[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-list'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mlist_all_entities[2m > [22m[2mshould filter entities by operations
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"filter_by_operations":["create","delete"]}
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483656421
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-filter'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:36.405 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-list"
    category: "ai"
    eventType: "tool_executed"
    quantity: 10
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:36.408 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-list"
    toolName: "list_all_entities"
    durationMs: 10
    error: "Database pool not initialized"
[2025-12-11 15:07:36.410 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-list"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:36.411 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-list"
    inputTokens: 220
    outputTokens: 34
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:36.424 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-filter"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:36.424 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-filter"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/routes/sessions.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

[2025-12-11 15:07:35.862 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-123"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:35.863 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-123"
    inputTokens: 100
    outputTokens: 15
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:35.881 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-tool"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:35.882 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-tool"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould execute query with tool use (list_all_entities)
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=43
[STREAM] content_block_stop (text): index=0, text_len=43, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=11
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m41[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m261[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-tool'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould enforce max turns limit (20 turns)
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483656924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m1[39m
}
[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483657924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m240[39m,
  outputTokens: [33m60[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m300[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould enforce max turns limit (20 turns)
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 3 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 3 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483658924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m360[39m,
  outputTokens: [33m90[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m450[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m3[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould enforce max turns limit (20 turns)
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 4 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 4 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483659924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m480[39m,
  outputTokens: [33m120[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m600[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m4[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould enforce max turns limit (20 turns)
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 5 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 5 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483660924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m600[39m,
  outputTokens: [33m150[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m750[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m5[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould enforce max turns limit (20 turns)
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 6 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 6 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483661924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m720[39m,
  outputTokens: [33m180[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m900[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m6[39m
}
[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 7 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 7 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483662924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m840[39m,
  outputTokens: [33m210[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1050[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m7[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould enforce max turns limit (20 turns)
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 8 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 8 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483663924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m960[39m,
  outputTokens: [33m240[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1200[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m8[39m
}
[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 9 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 9 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483664924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1080[39m,
  outputTokens: [33m270[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1350[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m9[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould enforce max turns limit (20 turns)
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 10 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 10 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483665924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1200[39m,
  outputTokens: [33m300[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1500[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m10[39m
}
[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 11 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 11 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483666924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1320[39m,
  outputTokens: [33m330[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1650[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m11[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould enforce max turns limit (20 turns)
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 12 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 12 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483667924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1440[39m,
  outputTokens: [33m360[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1800[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m12[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould enforce max turns limit (20 turns)
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 13 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 13 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483668924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1560[39m,
  outputTokens: [33m390[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1950[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m13[39m
}
[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 14 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 14 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483669924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1680[39m,
  outputTokens: [33m420[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m2100[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m14[39m
}
[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 15 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 15 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483670924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1800[39m,
  outputTokens: [33m450[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m2250[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m15[39m
}
[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 16 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 16 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483671924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1920[39m,
  outputTokens: [33m480[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m2400[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m16[39m
}
[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 17 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 17 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483672924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m2040[39m,
  outputTokens: [33m510[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m2550[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m17[39m
}

[2025-12-11 15:07:36.909 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-tool"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould enforce max turns limit (20 turns)
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 18 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 18 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483673924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m2160[39m,
  outputTokens: [33m540[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m2700[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m18[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould enforce max turns limit (20 turns)
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 19 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 19 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483674924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m2280[39m,
  outputTokens: [33m570[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m2850[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m19[39m
}
[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 20 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 20 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483675924
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m2400[39m,
  outputTokens: [33m600[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m3000[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m20[39m
}

[2025-12-11 15:07:36.909 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-tool"
    toolName: "list_all_entities"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:07:36.914 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-tool"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:36.915 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-tool"
    inputTokens: 220
    outputTokens: 41
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:36.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:36.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:37.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:37.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:37.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 240
    unit: "tokens"
    cost: 0.00072
    error: "Database pool not initialized"
[2025-12-11 15:07:37.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 240
    outputTokens: 60
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:38.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:38.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:38.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 360
    unit: "tokens"
    cost: 0.00108
    error: "Database pool not initialized"
[2025-12-11 15:07:38.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 360
    outputTokens: 90
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:39.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:39.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:39.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 480
    unit: "tokens"
    cost: 0.00144
    error: "Database pool not initialized"
[2025-12-11 15:07:39.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 480
    outputTokens: 120
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:40.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:40.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:40.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 600
    unit: "tokens"
    cost: 0.0018
    error: "Database pool not initialized"
[2025-12-11 15:07:40.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 600
    outputTokens: 150
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:41.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:41.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:41.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 720
    unit: "tokens"
    cost: 0.00216
    error: "Database pool not initialized"
[2025-12-11 15:07:41.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 720
    outputTokens: 180
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:42.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:42.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:42.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 840
    unit: "tokens"
    cost: 0.00252
    error: "Database pool not initialized"
[2025-12-11 15:07:42.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 840
    outputTokens: 210
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:43.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:43.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:43.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 960
    unit: "tokens"
    cost: 0.00288
    error: "Database pool not initialized"
[2025-12-11 15:07:43.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 960
    outputTokens: 240
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:44.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:44.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:44.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1080
    unit: "tokens"
    cost: 0.0032400000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:44.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 1080
    outputTokens: 270
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:45.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:45.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:45.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1200
    unit: "tokens"
    cost: 0.0036
    error: "Database pool not initialized"
[2025-12-11 15:07:45.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 1200
    outputTokens: 300
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:46.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:46.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:46.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1320
    unit: "tokens"
    cost: 0.00396
    error: "Database pool not initialized"
[2025-12-11 15:07:46.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 1320
    outputTokens: 330
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:47.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:47.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:47.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1440
    unit: "tokens"
    cost: 0.00432
    error: "Database pool not initialized"
[2025-12-11 15:07:47.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 1440
    outputTokens: 360
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:48.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:48.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:48.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1560
    unit: "tokens"
    cost: 0.00468
    error: "Database pool not initialized"
[2025-12-11 15:07:48.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 1560
    outputTokens: 390
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:49.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:49.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:49.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1680
    unit: "tokens"
    cost: 0.00504
    error: "Database pool not initialized"
[2025-12-11 15:07:49.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 1680
    outputTokens: 420
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:50.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:50.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:50.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1800
    unit: "tokens"
    cost: 0.0054
    error: "Database pool not initialized"
[2025-12-11 15:07:50.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 1800
    outputTokens: 450
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:51.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:51.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:51.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1920
    unit: "tokens"
    cost: 0.00576
    error: "Database pool not initialized"
[2025-12-11 15:07:51.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 1920
    outputTokens: 480
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:52.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:52.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 2040
    unit: "tokens"
    cost: 0.0061200000000000004
    error: "Database pool not initialized"
[2025-12-11 15:07:52.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 2040
    outputTokens: 510
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:53.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:53.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:53.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 2160
    unit: "tokens"
    cost: 0.0064800000000000005
    error: "Database pool not initialized"
[2025-12-11 15:07:53.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 2160
    outputTokens: 540
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:54.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:54.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:54.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 2280
    unit: "tokens"
    cost: 0.006840000000000001
    error: "Database pool not initialized"
[2025-12-11 15:07:54.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 2280
    outputTokens: 570
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:55.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:55.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:55.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 2400
    unit: "tokens"
    cost: 0.0072
    error: "Database pool not initialized"
[2025-12-11 15:07:55.924 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    inputTokens: 2400
    outputTokens: 600
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:56.924 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:56.924 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:37.018 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-approval"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:37.018 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-approval"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould enforce max turns limit (20 turns)
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould handle write operation approval (approved)
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"name":"Test Customer"}
[STREAM] content_block_stop (tool_use): index=0, tool=create_customer, id=tool-use-1765483657012
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-approval'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mlist_all_entities[2m > [22m[2mshould filter entities by operations
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=17
[STREAM] content_block_stop (text): index=0, text_len=17, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=5
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m35[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m255[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-filter'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mlist_all_entities[2m > [22m[2mshould handle missing bc_index.json
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483657475
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-missing'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:37.462 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-filter"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:37.463 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-filter"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:37.467 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-filter"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:37.467 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-filter"
    inputTokens: 220
    outputTokens: 35
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:37.477 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-missing"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:37.477 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-missing"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/services/files/processors/ExcelProcessor.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 351[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/agent/tool-definitions.test.ts [2m([22m[2m44 tests[22m[2m)[22m[90m 65[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts[2m > [22m[2mPerformance Tests[2m > [22m[2mConcurrent Request Handling[2m > [22m[2mshould handle 100 concurrent token-usage/me requests with SLA compliance
[22m[39m[PERF] 100 concurrent token-usage/me:
  - Total duration: 1863ms
  - Avg response: 1491.99ms
  - P95: 1520.00ms
  - P99: 1523.00ms
  - Max: 1530.00ms
  - Requests/sec: 53.68

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould handle write operation approval (approved)
[22m[39m[DirectAgentService] Executing MCP tool: create_customer

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=29
[STREAM] content_block_stop (text): index=0, text_len=29, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=8
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m38[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m258[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-approval'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould handle write operation denial (denied)
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"confirm":true}
[STREAM] content_block_stop (tool_use): index=0, tool=delete_customers, id=tool-use-1765483658072
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-denied'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:38.042 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-approval"
    category: "ai"
    eventType: "tool_executed"
    quantity: 15
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:38.043 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-approval"
    toolName: "create_customer"
    durationMs: 15
    error: "Database pool not initialized"
[2025-12-11 15:07:38.043 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:38.044 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-approval"
    turnCount: 1
    userId: "user-test-123"
    toolUseId: "tool-use-1765483657012"
    toolName: "create_customer"
    updateSuccess: true
    error: "Unknown tool: create_customer"
[2025-12-11 15:07:38.044 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:38.047 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-approval"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:38.047 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-approval"
    inputTokens: 220
    outputTokens: 38
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:38.078 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-denied"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:38.078 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-denied"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/routes/sessions.transformers.test.ts [2m([22m[2m18 tests[22m[2m)[22m[90m 25[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/agent/messages/StreamProcessor.test.ts [2m([22m[2m13 tests[22m[2m)[22m[90m 49[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/agent/citations.test.ts [2m([22m[2m33 tests[22m[2m | [22m[33m6 skipped[39m[2m)[22m[90m 63[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mlist_all_entities[2m > [22m[2mshould handle missing bc_index.json
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=13
[STREAM] content_block_stop (text): index=0, text_len=13, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m34[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m254[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-missing'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2msearch_entity_operations[2m > [22m[2mshould search entities by keyword
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"keyword":"customer"}
[STREAM] content_block_stop (tool_use): index=0, tool=search_entity_operations, id=tool-use-1765483658542
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-search'[39m,
  turnCount: [33m1[39m
}

 [32mΓ£ô[39m src/__tests__/unit/agent/stop-reasons.test.ts [2m([22m[2m38 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[90m 81[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/input-sanitization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ≡ƒöÉ prevent building .env in docker: https://dotenvx.com/prebuild

 [32mΓ£ô[39m src/__tests__/unit/services/files/processors/TextProcessor.test.ts [2m([22m[2m29 tests[22m[2m)[22m[90m 68[2mms[22m[39m
[2025-12-11 15:07:38.522 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-missing"
    category: "ai"
    eventType: "tool_executed"
    quantity: 12
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:38.522 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-missing"
    toolName: "list_all_entities"
    durationMs: 12
    error: "Database pool not initialized"
[2025-12-11 15:07:38.523 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:38.523 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-missing"
    turnCount: 1
    userId: "user-123"
    toolUseId: "tool-use-1765483657475"
    toolName: "list_all_entities"
    updateSuccess: true
    error: "Master index not found at D:\\Documents\\BC-Claude-Agent-prototype\\backend/mcp-server/data/v1.0/bc_index.json"
[2025-12-11 15:07:38.523 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:38.526 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-missing"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:38.526 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-missing"
    inputTokens: 220
    outputTokens: 34
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:38.545 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-search"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:38.545 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-search"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/services/sessions/SessionTitleGenerator.test.ts [2m([22m[2m15 tests[22m[2m)[22m[90m 35[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould handle write operation denial (denied)
[22m[39m
========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=31
[STREAM] content_block_stop (text): index=0, text_len=31, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=8
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m38[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m258[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-denied'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould handle tool execution error
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"test":"data"}
[STREAM] content_block_stop (tool_use): index=0, tool=unknown_tool_that_does_not_exist, id=tool-use-1765483659093
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-error'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:39.088 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-denied"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:39.088 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-denied"
    inputTokens: 220
    outputTokens: 38
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:39.094 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-error"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:39.095 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-error"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2msearch_entity_operations[2m > [22m[2mshould search entities by keyword
[22m[39m[DirectAgentService] Executing MCP tool: search_entity_operations

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=13
[STREAM] content_block_stop (text): index=0, text_len=13, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m34[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m254[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-search'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2msearch_entity_operations[2m > [22m[2mshould apply risk level filter
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"keyword":"customer","filter_by_risk":"HIGH"}
[STREAM] content_block_stop (tool_use): index=0, tool=search_entity_operations, id=tool-use-1765483659557
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-risk'[39m,
  turnCount: [33m1[39m
}

 [32mΓ£ô[39m src/__tests__/unit/routes/sessions.routes.test.ts [2m([22m[2m25 tests[22m[2m)[22m[33m 1128[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts[2m > [22m[2mPerformance Tests[2m > [22m[2mConcurrent Request Handling[2m > [22m[2mshould handle 100 concurrent log batch requests with SLA compliance
[22m[39m[PERF] 100 concurrent log batches:
  - Total duration: 2228ms
  - Avg response: 1928.50ms
  - P95: 1949.00ms
  - P99: 1951.00ms
  - Max: 1952.00ms
  - Requests/sec: 44.88

[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mvalidateSessionOwnership[2m > [22m[2mshould return isOwner=true when user owns the session
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'user-owner-123'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m
}

[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mvalidateSessionOwnership[2m > [22m[2mshould return isOwner=false with NOT_OWNER error when user does not own session
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-other-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'user-owner-123'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-other-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'NOT_OWNER'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-other-456'[39m,
  actualOwner: [32m'user-owner-123'[39m
}

[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mvalidateSessionOwnership[2m > [22m[2mshould return isOwner=false with SESSION_NOT_FOUND error when session does not exist
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'non-existent-session'[39m,
  userId: [32m'user-owner-123'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m0[39m,
  firstRow: [90mundefined[39m,
  sessionId: [32m'non-existent-session'[39m,
  userId: [32m'user-owner-123'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SESSION_NOT_FOUND'[39m,
  sessionId: [32m'non-existent-session'[39m,
  userId: [32m'user-owner-123'[39m
}

[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mvalidateSessionOwnership[2m > [22m[2mshould return isOwner=false with DATABASE_ERROR error when query fails
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}

[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mrequireSessionOwnership[2m > [22m[2mshould not throw when user owns the session
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'user-owner-123'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m
}

[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mrequireSessionOwnership[2m > [22m[2mshould throw "Unauthorized" error when user does not own session
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-other-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'user-owner-123'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-other-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'NOT_OWNER'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-other-456'[39m,
  actualOwner: [32m'user-owner-123'[39m
}

[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mrequireSessionOwnership[2m > [22m[2mshould throw "not found" error when session does not exist
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'non-existent'[39m,
  userId: [32m'user-owner-123'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m0[39m,
  firstRow: [90mundefined[39m,
  sessionId: [32m'non-existent'[39m,
  userId: [32m'user-owner-123'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SESSION_NOT_FOUND'[39m,
  sessionId: [32m'non-existent'[39m,
  userId: [32m'user-owner-123'[39m
}

[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mrequireSessionOwnershipMiddleware[2m > [22m[2mshould call next() when user owns the session
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'user-owner-123'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m
}

[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mrequireSessionOwnershipMiddleware[2m > [22m[2mshould return 403 when user does not own the session
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-other-456'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'user-owner-123'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-other-456'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'NOT_OWNER'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-other-456'[39m,
  actualOwner: [32m'user-owner-123'[39m
}

[2025-12-11 15:07:39.550 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-search"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:39.550 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-search"
    toolName: "search_entity_operations"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:07:39.552 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-search"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:39.552 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-search"
    inputTokens: 220
    outputTokens: 34
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:39.559 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-risk"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:39.560 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-risk"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mrequireSessionOwnershipMiddleware[2m > [22m[2mshould return 404 when session does not exist
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'non-existent'[39m,
  userId: [32m'user-owner-123'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m0[39m,
  firstRow: [90mundefined[39m,
  sessionId: [32m'non-existent'[39m,
  userId: [32m'user-owner-123'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SESSION_NOT_FOUND'[39m,
  sessionId: [32m'non-existent'[39m,
  userId: [32m'user-owner-123'[39m
}

[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mrequireSessionOwnershipMiddleware[2m > [22m[2mshould use custom parameter name when specified
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'user-owner-123'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-123'[39m
}

[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mMulti-Tenant Security Scenarios[2m > [22m[2mshould prevent User A from accessing User B session via ownership check
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'session-belongs-to-user-b'[39m,
  userId: [32m'user-a-attacker'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'user-b-victim'[39m },
  sessionId: [32m'session-belongs-to-user-b'[39m,
  userId: [32m'user-a-attacker'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'NOT_OWNER'[39m,
  sessionId: [32m'session-belongs-to-user-b'[39m,
  userId: [32m'user-a-attacker'[39m,
  actualOwner: [32m'user-b-victim'[39m
}

[90mstdout[2m | src/__tests__/unit/session-ownership.test.ts[2m > [22m[2mSession Ownership Utilities[2m > [22m[2mMulti-Tenant Security Scenarios[2m > [22m[2mshould allow legitimate access when IDs match
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'legitimate-session'[39m,
  userId: [32m'legitimate-user'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'legitimate-user'[39m },
  sessionId: [32m'legitimate-session'[39m,
  userId: [32m'legitimate-user'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'legitimate-session'[39m,
  userId: [32m'legitimate-user'[39m
}

 [32mΓ£ô[39m src/__tests__/unit/session-ownership.test.ts [2m([22m[2m24 tests[22m[2m)[22m[90m 83[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould handle tool execution error
[22m[39m[DirectAgentService] Executing MCP tool: unknown_tool_that_does_not_exist

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=39
[STREAM] content_block_stop (text): index=0, text_len=39, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=10
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m40[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m260[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-error'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould handle max_tokens stop reason
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-max-tokens, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=50
[STREAM] content_block_stop (text): index=0, text_len=50, citations=0
[STREAM] message_delta: stop_reason=max_tokens
[STREAM] message_delta: output_tokens=4096
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=max_tokens, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-max-tokens'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m4096[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m4196[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-tokens'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:40.127 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-error"
    category: "ai"
    eventType: "tool_executed"
    quantity: 2
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould handle API errors gracefully
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)

[2025-12-11 15:07:40.128 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-error"
    toolName: "unknown_tool_that_does_not_exist"
    durationMs: 2
    error: "Database pool not initialized"
[2025-12-11 15:07:40.128 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:40.131 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-error"
    turnCount: 1
    userId: "user-test-123"
    toolUseId: "tool-use-1765483659093"
    toolName: "unknown_tool_that_does_not_exist"
    updateSuccess: true
    error: "Unknown tool: unknown_tool_that_does_not_exist"
[2025-12-11 15:07:40.132 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:40.139 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-error"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:40.139 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-error"
    inputTokens: 220
    outputTokens: 40
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:40.150 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-tokens"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:40.150 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-max-tokens"
    inputTokens: 100
    outputTokens: 4096
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:40.157 -0500] [31mERROR[39m: [36mundefined - Γ¥î Stream creation failed[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-api-error"
    turnCount: 1
    errorType: "Error"
    stack: "Error: API rate limit exceeded\n    at D:\Documents\BC-Claude-Agent-prototype\backend\src\__tests__\unit\services\agent\DirectAgentService.test.ts:579:24\n    at file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:146:14\n    at file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:533:11\n    at runWithTimeout (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:39:7)\n    at runTest (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:1056:17)\n    at runSuite (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:1205:15)\n    at runSuite (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:1205:15)\n    at runSuite (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:1205:15)\n    at runFiles (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:1262:5)\n    at startTests (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:1271:3)"
    error: "API rate limit exceeded"
[2025-12-11 15:07:40.162 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-events"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:40.162 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-events"
    inputTokens: 100
    outputTokens: 4
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:40.171 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:40.172 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mexecuteQueryStreaming[2m > [22m[2mshould emit all event types correctly
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=13
[STREAM] content_block_stop (text): index=0, text_len=13, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m4[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m104[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-events'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2misWriteOperation (private method behavior)[2m > [22m[2mshould require approval for write operations via tool name detection
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=create_customer, id=tool-use-1765483660170
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-write'[39m,
  turnCount: [33m1[39m
}

 [32mΓ£ô[39m src/__tests__/unit/utils/error-response.test.ts [2m([22m[2m32 tests[22m[2m)[22m[90m 79[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/agent/messages/MessageEmitter.test.ts [2m([22m[2m23 tests[22m[2m)[22m[90m 133[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/queue/MessageQueue.close.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ΓÜÖ∩╕Å  write to custom object with { processEnv: myObject }

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2msearch_entity_operations[2m > [22m[2mshould apply risk level filter
[22m[39m[DirectAgentService] Executing MCP tool: search_entity_operations

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=20
[STREAM] content_block_stop (text): index=0, text_len=20, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=5
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m35[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m255[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-risk'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2msearch_entity_operations[2m > [22m[2mshould apply operation type filter
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"keyword":"customer","filter_by_operation_type":"create"}
[STREAM] content_block_stop (tool_use): index=0, tool=search_entity_operations, id=tool-use-1765483660573
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-optype'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:40.567 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-risk"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:40.567 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-risk"
    toolName: "search_entity_operations"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:07:40.568 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-risk"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:40.569 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-risk"
    inputTokens: 220
    outputTokens: 35
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:40.575 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-optype"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:40.575 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-optype"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/tracking/UsageTrackingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ≡ƒôí add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts[2m > [22m[2mPerformance Tests[2m > [22m[2mConcurrent Request Handling[2m > [22m[2mshould handle multi-tenant concurrent access with data isolation verification
[22m[39m[PERF] Multi-tenant (10 users x 10 requests):
  - Total requests: 100
  - Total duration: 1789ms
  - All successful: true
  - Data isolation verified: YES

[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts[2m > [22m[2mPerformance Tests[2m > [22m[2mResponse Time Validation[2m > [22m[2mshould return token-usage/me within SLA threshold
[22m[39m[PERF] Single token-usage/me: 72ms (threshold: 500ms)

[90mstdout[2m | src/__tests__/unit/services/search/VectorSearchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ≡ƒ¢á∩╕Å  run anywhere with `dotenvx run -- yourcommand`

 [32mΓ£ô[39m src/__tests__/unit/server.socket.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 1923[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/tracking/UsageTrackingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[90m 61[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/search/VectorSearchService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[90m 69[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2misWriteOperation (private method behavior)[2m > [22m[2mshould require approval for write operations via tool name detection
[22m[39m[DirectAgentService] Executing MCP tool: create_customer

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=4
[STREAM] content_block_stop (text): index=0, text_len=4, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=1
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m31[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m251[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-write'[39m,
  turnCount: [33m2[39m
}

========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=update_item, id=tool-use-1765483661188
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-write'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts[2m > [22m[2mPerformance Tests[2m > [22m[2mResponse Time Validation[2m > [22m[2mshould process 100-item log batch within batch threshold
[22m[39m[PERF] 100-item log batch: 33ms (threshold: 1000ms)

 [32mΓ£ô[39m src/__tests__/unit/utils/retry.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 972[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Retry Utility[2m > [22mExponential Backoff[2m > [22mshould apply jitter within bounds [33m329[2mms[22m[39m
[2025-12-11 15:07:41.185 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    category: "ai"
    eventType: "tool_executed"
    quantity: 2
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:41.185 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    toolName: "create_customer"
    durationMs: 2
    error: "Database pool not initialized"
[2025-12-11 15:07:41.185 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:41.185 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-write"
    turnCount: 1
    userId: "user-test-123"
    toolUseId: "tool-use-1765483660170"
    toolName: "create_customer"
    updateSuccess: true
    error: "Unknown tool: create_customer"
[2025-12-11 15:07:41.185 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:41.186 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:41.186 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    inputTokens: 220
    outputTokens: 31
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:41.189 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:41.190 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts[2m > [22m[2mPerformance Tests[2m > [22m[2mResponse Time Validation[2m > [22m[2mshould maintain SLA-compliant response times under moderate load
[22m[39m[PERF] 50 concurrent performance metrics:
  - Avg: 603.30ms
  - Median (P50): 604.00ms
  - P95: 613.00ms (SLA: <3000ms)
  - P99: 675.00ms (SLA: <4000ms)
  - Max: 675.00ms (Bound: <6000ms)

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2msearch_entity_operations[2m > [22m[2mshould apply operation type filter
[22m[39m[DirectAgentService] Executing MCP tool: search_entity_operations

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=17
[STREAM] content_block_stop (text): index=0, text_len=17, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=5
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m35[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m255[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-optype'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mget_entity_details[2m > [22m[2mshould get entity details by name
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"entity_name":"customer"}
[STREAM] content_block_stop (tool_use): index=0, tool=get_entity_details, id=tool-use-1765483661592
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-details'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:41.587 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-optype"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/services/events/SequenceValidator.test.ts [2m([22m[2m23 tests[22m[2m)[22m[90m 78[2mms[22m[39m
[2025-12-11 15:07:41.587 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-optype"
    toolName: "search_entity_operations"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:07:41.588 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-optype"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:41.588 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-optype"
    inputTokens: 220
    outputTokens: 35
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:41.594 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-details"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:41.594 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-details"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/agent/e2e-data-flow.test.ts [2m([22m[2m38 tests[22m[2m | [22m[33m1 skipped[39m[2m)[22m[90m 54[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2misWriteOperation (private method behavior)[2m > [22m[2mshould require approval for write operations via tool name detection
[22m[39m[DirectAgentService] Executing MCP tool: update_item

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=4
[STREAM] content_block_stop (text): index=0, text_len=4, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=1
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m31[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m251[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-write'[39m,
  turnCount: [33m2[39m
}

========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=delete_record, id=tool-use-1765483662204
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-write'[39m,
  turnCount: [33m1[39m
}

 [32mΓ£ô[39m src/__tests__/unit/constants/errors.test.ts [2m([22m[2m31 tests[22m[2m)[22m[90m 66[2mms[22m[39m
[2025-12-11 15:07:42.201 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    category: "ai"
    eventType: "tool_executed"
    quantity: 2
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:42.201 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    toolName: "update_item"
    durationMs: 2
    error: "Database pool not initialized"
[2025-12-11 15:07:42.201 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:42.201 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-write"
    turnCount: 1
    userId: "user-test-123"
    toolUseId: "tool-use-1765483661188"
    toolName: "update_item"
    updateSuccess: true
    error: "Unknown tool: update_item"
[2025-12-11 15:07:42.201 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:42.202 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:42.202 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    inputTokens: 220
    outputTokens: 31
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:42.206 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:42.206 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/agent/messages/MessageOrderingService.test.ts [2m([22m[2m19 tests[22m[2m)[22m[90m 65[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/agent/input-sanitization.test.ts [2m([22m[2m58 tests[22m[2m)[22m[90m 63[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mget_entity_details[2m > [22m[2mshould get entity details by name
[22m[39m[DirectAgentService] Executing MCP tool: get_entity_details

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=16
[STREAM] content_block_stop (text): index=0, text_len=16, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m34[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m254[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-details'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mget_entity_details[2m > [22m[2mshould handle entity not found
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"entity_name":"nonexistent"}
[STREAM] content_block_stop (tool_use): index=0, tool=get_entity_details, id=tool-use-1765483662608
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-notfound'[39m,
  turnCount: [33m1[39m
}

 [32mΓ£ô[39m src/__tests__/unit/services/token-usage/TokenUsageService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[90m 93[2mms[22m[39m
[2025-12-11 15:07:42.599 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-details"
    category: "ai"
    eventType: "tool_executed"
    quantity: 2
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:42.599 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-details"
    toolName: "get_entity_details"
    durationMs: 2
    error: "Database pool not initialized"
[2025-12-11 15:07:42.601 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-details"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:42.602 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-details"
    inputTokens: 220
    outputTokens: 34
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:42.610 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-notfound"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:42.610 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-notfound"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/services/files/FileUploadService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[90m 99[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2misWriteOperation (private method behavior)[2m > [22m[2mshould require approval for write operations via tool name detection
[22m[39m[DirectAgentService] Executing MCP tool: delete_record

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=4
[STREAM] content_block_stop (text): index=0, text_len=4, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=1
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m31[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m251[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-write'[39m,
  turnCount: [33m2[39m
}

========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=post_invoice, id=tool-use-1765483663224
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-write'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/utils/session-ownership.security.test.ts[2m > [22m[2mSession Ownership Security[2m > [22m[2mvalidateSessionOwnership timing attack protection[2m > [22m[2mshould successfully validate when user owns session
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-secure'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'user-owner-secure'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-secure'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SUCCESS'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-owner-secure'[39m
}

[90mstdout[2m | src/__tests__/unit/utils/session-ownership.security.test.ts[2m > [22m[2mSession Ownership Security[2m > [22m[2mvalidateSessionOwnership timing attack protection[2m > [22m[2mshould reject with NOT_OWNER when user does not own session
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-attacker'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'user-owner-secure'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-attacker'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'NOT_OWNER'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-attacker'[39m,
  actualOwner: [32m'user-owner-secure'[39m
}

[90mstdout[2m | src/__tests__/unit/utils/session-ownership.security.test.ts[2m > [22m[2mSession Ownership Security[2m > [22m[2mvalidateSessionOwnership timing attack protection[2m > [22m[2mshould prevent timing-based enumeration of valid user IDs
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'c'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'correct-user-id-12345'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'c'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'NOT_OWNER'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'c'[39m,
  actualOwner: [32m'correct-user-id-12345'[39m
}
[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'co'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'correct-user-id-12345'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'co'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'NOT_OWNER'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'co'[39m,
  actualOwner: [32m'correct-user-id-12345'[39m
}
[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'cor'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'correct-user-id-12345'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'cor'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'NOT_OWNER'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'cor'[39m,
  actualOwner: [32m'correct-user-id-12345'[39m
}
[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'correct-user-id-12344'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'correct-user-id-12345'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'correct-user-id-12344'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'NOT_OWNER'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'correct-user-id-12344'[39m,
  actualOwner: [32m'correct-user-id-12345'[39m
}
[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'wrong-user-completely'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m1[39m,
  firstRow: { user_id: [32m'correct-user-id-12345'[39m },
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'wrong-user-completely'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'NOT_OWNER'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'wrong-user-completely'[39m,
  actualOwner: [32m'correct-user-id-12345'[39m
}

[90mstdout[2m | src/__tests__/unit/utils/session-ownership.security.test.ts[2m > [22m[2mSession Ownership Security[2m > [22m[2mvalidateSessionOwnership timing attack protection[2m > [22m[2mshould handle session not found before comparing user IDs
[22m[39m[E2E-DEBUG] validateSessionOwnership called: {
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-attacker'[39m,
  sessionIdType: [32m'string'[39m,
  userIdType: [32m'string'[39m
}
[E2E-DEBUG] Database query result: {
  hasRecordset: [33mtrue[39m,
  recordsetLength: [33m0[39m,
  firstRow: [90mundefined[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-attacker'[39m
}
[E2E-DEBUG] validateSessionOwnership returning: {
  result: [32m'SESSION_NOT_FOUND'[39m,
  sessionId: [32m'550e8400-e29b-41d4-a716-446655440000'[39m,
  userId: [32m'user-attacker'[39m
}

 [32mΓ£ô[39m src/__tests__/unit/utils/session-ownership.security.test.ts [2m([22m[2m24 tests[22m[2m)[22m[90m 55[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/auth/BCTokenManager.raceCondition.test.ts [2m([22m[2m6 tests[22m[2m)[22m[90m 174[2mms[22m[39m
[2025-12-11 15:07:43.221 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    category: "ai"
    eventType: "tool_executed"
    quantity: 2
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:43.222 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    toolName: "delete_record"
    durationMs: 2
    error: "Database pool not initialized"
[2025-12-11 15:07:43.222 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:43.222 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-write"
    turnCount: 1
    userId: "user-test-123"
    toolUseId: "tool-use-1765483662204"
    toolName: "delete_record"
    updateSuccess: true
    error: "Unknown tool: delete_record"
[2025-12-11 15:07:43.222 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:43.223 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:43.223 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    inputTokens: 220
    outputTokens: 31
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:43.226 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:43.226 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/embeddings/EmbeddingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ≡ƒæÑ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mget_entity_details[2m > [22m[2mshould handle entity not found
[22m[39m[DirectAgentService] Executing MCP tool: get_entity_details

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=16
[STREAM] content_block_stop (text): index=0, text_len=16, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m34[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m254[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-notfound'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mget_entity_relationships[2m > [22m[2mshould get entity relationships
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"entity_name":"customer"}
[STREAM] content_block_stop (tool_use): index=0, tool=get_entity_relationships, id=tool-use-1765483663636
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-rels'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:43.627 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-notfound"
    category: "ai"
    eventType: "tool_executed"
    quantity: 2
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:43.627 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-notfound"
    toolName: "get_entity_details"
    durationMs: 2
    error: "Database pool not initialized"
[2025-12-11 15:07:43.627 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:43.628 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-notfound"
    turnCount: 1
    userId: "user-123"
    toolUseId: "tool-use-1765483662608"
    toolName: "get_entity_details"
    updateSuccess: true
    error: "Entity 'nonexistent' not found"
[2025-12-11 15:07:43.628 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:43.628 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-notfound"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:43.628 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-notfound"
    inputTokens: 220
    outputTokens: 34
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:43.638 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-rels"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:43.638 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-rels"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/utils/logger.test.ts [2m([22m[2m17 tests[22m[2m)[22m[90m 149[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/embeddings/EmbeddingService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[90m 45[2mms[22m[39m
 [32mΓ£ô[39m src/utils/sql/validators.test.ts [2m([22m[2m24 tests[22m[2m)[22m[90m 29[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/queue/MessageQueue.rateLimit.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 5768[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m MessageQueue Rate Limiting[2m > [22mRedis Failure Handling[2m > [22mshould return default status when Redis get fails [33m301[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m MessageQueue Rate Limiting[2m > [22mCounter Management[2m > [22mshould use correct Redis key format [33m301[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m MessageQueue Rate Limiting[2m > [22mEdge Cases[2m > [22mshould handle concurrent rate limit checks [33m310[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m MessageQueue Rate Limiting[2m > [22mEdge Cases[2m > [22mshould handle rate limit at exact boundary (count = 100) [33m316[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m MessageQueue Rate Limiting[2m > [22mRate Limit Status API[2m > [22mshould return correct status for partially used session [33m325[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2misWriteOperation (private method behavior)[2m > [22m[2mshould require approval for write operations via tool name detection
[22m[39m[DirectAgentService] Executing MCP tool: post_invoice

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=4
[STREAM] content_block_stop (text): index=0, text_len=4, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=1
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m31[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m251[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-write'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2misWriteOperation (private method behavior)[2m > [22m[2mshould not require approval for read operations
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483664239
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-read'[39m,
  turnCount: [33m1[39m
}

 [32mΓ£ô[39m src/__tests__/unit/services/chunking/RecursiveChunkingStrategy.test.ts [2m([22m[2m22 tests[22m[2m)[22m[90m 117[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/websocket/extended-thinking-config.test.ts [2m([22m[2m16 tests[22m[2m)[22m[90m 15[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mget_entity_relationships[2m > [22m[2mshould get entity relationships
[22m[39m[DirectAgentService] Executing MCP tool: get_entity_relationships

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=22
[STREAM] content_block_stop (text): index=0, text_len=22, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=6
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m36[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m256[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-rels'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mvalidate_workflow_structure[2m > [22m[2mshould validate a valid workflow
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"workflow":[{"operation_id":"listCustomers","label":"List"},{"operation_id":"createCustomer","label":"Create"}]}
[STREAM] content_block_stop (tool_use): index=0, tool=validate_workflow_structure, id=tool-use-1765483664655
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-validate'[39m,
  turnCount: [33m1[39m
}

 [32mΓ£ô[39m src/__tests__/unit/services/chunking/SemanticChunkingStrategy.test.ts [2m([22m[2m20 tests[22m[2m)[22m[90m 29[2mms[22m[39m
[2025-12-11 15:07:44.232 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    category: "ai"
    eventType: "tool_executed"
    quantity: 3
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:44.232 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    toolName: "post_invoice"
    durationMs: 3
    error: "Database pool not initialized"
[2025-12-11 15:07:44.232 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:44.232 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-write"
    turnCount: 1
    userId: "user-test-123"
    toolUseId: "tool-use-1765483663224"
    toolName: "post_invoice"
    updateSuccess: true
    error: "Unknown tool: post_invoice"
[2025-12-11 15:07:44.232 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:44.235 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:44.236 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-write"
    inputTokens: 220
    outputTokens: 31
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:44.241 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-read"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:44.241 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-read"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:44.646 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-rels"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:44.646 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-rels"
    toolName: "get_entity_relationships"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:07:44.648 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-rels"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:44.649 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-rels"
    inputTokens: 220
    outputTokens: 36
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:44.656 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-validate"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:44.656 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-validate"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/services/queue/MessageQueue.close.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 3230[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m MessageQueue.close()[2m > [22mshould close in correct order: workers ΓåÆ queueEvents ΓåÆ queues ΓåÆ redis [33m497[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m MessageQueue.close()[2m > [22mshould collect errors but not throw during shutdown [33m508[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m MessageQueue.close()[2m > [22mshould not close Redis when injected (ownsRedisConnection = false) [33m509[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m MessageQueue.close()[2m > [22mshould be idempotent (safe to call twice) [33m979[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m MessageQueue.close()[2m > [22mshould set isReady to false after close [33m504[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2misWriteOperation (private method behavior)[2m > [22m[2mshould not require approval for read operations
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=15
[STREAM] content_block_stop (text): index=0, text_len=15, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m34[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m254[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-read'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mPrompt Caching[2m > [22m[2mshould use array with cache_control when ENABLE_PROMPT_CACHING=true
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=8
[STREAM] content_block_stop (text): index=0, text_len=8, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=2
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m2[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m102[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-test'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.test.ts[2m > [22m[2mDirectAgentService[2m > [22m[2mPrompt Caching[2m > [22m[2mshould include cache_control with ephemeral type
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=8
[STREAM] content_block_stop (text): index=0, text_len=8, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=2
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m2[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m102[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-test'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:45.245 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-read"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:45.246 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-read"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:45.247 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-read"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:45.247 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-read"
    inputTokens: 220
    outputTokens: 34
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:45.256 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-test"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:45.257 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-test"
    inputTokens: 100
    outputTokens: 2
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:45.262 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-test"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:45.262 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-test-123"
    sessionId: "session-test"
    inputTokens: 100
    outputTokens: 2
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/services/agent/DirectAgentService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 9458[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService[2m > [22mexecuteQueryStreaming[2m > [22mshould execute query with tool use (list_all_entities) [33m1045[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService[2m > [22mexecuteQueryStreaming[2m > [22mshould handle write operation approval (approved) [33m1041[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService[2m > [22mexecuteQueryStreaming[2m > [22mshould handle write operation denial (denied) [33m1040[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService[2m > [22mexecuteQueryStreaming[2m > [22mshould handle tool execution error [33m1051[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService[2m > [22misWriteOperation (private method behavior)[2m > [22mshould require approval for write operations via tool name detection [33m4071[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService[2m > [22misWriteOperation (private method behavior)[2m > [22mshould not require approval for read operations [33m1010[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/file-types.test.ts [2m([22m[2m15 tests[22m[2m)[22m[90m 29[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mvalidate_workflow_structure[2m > [22m[2mshould validate a valid workflow
[22m[39m[DirectAgentService] Executing MCP tool: validate_workflow_structure

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=14
[STREAM] content_block_stop (text): index=0, text_len=14, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m34[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m254[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-validate'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mvalidate_workflow_structure[2m > [22m[2mshould handle invalid operation IDs
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"workflow":[{"operation_id":"invalidOp","label":"Invalid"}]}
[STREAM] content_block_stop (tool_use): index=0, tool=validate_workflow_structure, id=tool-use-1765483665679
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-invalid'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:45.665 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-validate"
    category: "ai"
    eventType: "tool_executed"
    quantity: 3
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:45.665 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-validate"
    toolName: "validate_workflow_structure"
    durationMs: 3
    error: "Database pool not initialized"
[2025-12-11 15:07:45.669 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-validate"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:45.670 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-validate"
    inputTokens: 220
    outputTokens: 34
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:45.681 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-invalid"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:45.681 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-invalid"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/services/chunking/RowBasedChunkingStrategy.test.ts [2m([22m[2m19 tests[22m[2m)[22m[90m 28[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/utils/sql/QueryBuilder.test.ts [2m([22m[2m18 tests[22m[2m)[22m[90m 33[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/config/database-helpers.test.ts [2m([22m[2m21 tests[22m[2m)[22m[90m 28[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mvalidate_workflow_structure[2m > [22m[2mshould handle invalid operation IDs
[22m[39m[DirectAgentService] Executing MCP tool: validate_workflow_structure

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=19
[STREAM] content_block_stop (text): index=0, text_len=19, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=5
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m35[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m255[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-invalid'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mvalidate_workflow_structure[2m > [22m[2mshould reject non-array workflow parameter
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"workflow":"not an array"}
[STREAM] content_block_stop (tool_use): index=0, tool=validate_workflow_structure, id=tool-use-1765483666701
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-type'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/queue/MessageQueue.embedding.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ΓÜÖ∩╕Å  enable debug logging with { debug: true }

 [32mΓ£ô[39m src/__tests__/unit/types/error.types.test.ts [2m([22m[2m15 tests[22m[2m)[22m[90m 15[2mms[22m[39m
[2025-12-11 15:07:46.688 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-invalid"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:46.689 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-invalid"
    toolName: "validate_workflow_structure"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:07:46.690 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-invalid"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:46.690 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-invalid"
    inputTokens: 220
    outputTokens: 35
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:46.703 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-type"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:46.703 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-type"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
 [32mΓ£ô[39m src/__tests__/unit/MockResponseLibrary.test.ts [2m([22m[2m13 tests[22m[2m)[22m[90m 79[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/services/chunking/ChunkingStrategyFactory.test.ts [2m([22m[2m10 tests[22m[2m)[22m[90m 19[2mms[22m[39m
[90mstdout[2m | src/utils/sql/validators.demo.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ≡ƒöä add secrets lifecycle management: https://dotenvx.com/ops

 [32mΓ£ô[39m src/utils/sql/validators.demo.test.ts [2m([22m[2m8 tests[22m[2m)[22m[90m 68[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mvalidate_workflow_structure[2m > [22m[2mshould reject non-array workflow parameter
[22m[39m[DirectAgentService] Executing MCP tool: validate_workflow_structure

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=5
[STREAM] content_block_stop (text): index=0, text_len=5, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=2
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m32[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m252[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-type'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mbuild_knowledge_base_workflow[2m > [22m[2mshould build workflow with enriched data
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"workflow_name":"Customer Setup","workflow_description":"Setup new customer","steps":[{"operation_id":"listCustomers"}]}
[STREAM] content_block_stop (tool_use): index=0, tool=build_knowledge_base_workflow, id=tool-use-1765483667730
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-build'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/integration/FileUploadUnicode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ΓÜÖ∩╕Å  override existing env vars with { override: true }

[2025-12-11 15:07:47.720 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-type"
    category: "ai"
    eventType: "tool_executed"
    quantity: 4
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:47.720 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-type"
    toolName: "validate_workflow_structure"
    durationMs: 4
    error: "Database pool not initialized"
[2025-12-11 15:07:47.721 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:47.721 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-type"
    turnCount: 1
    userId: "user-123"
    toolUseId: "tool-use-1765483666701"
    toolName: "validate_workflow_structure"
    updateSuccess: true
    error: "workflow parameter must be an array of steps"
[2025-12-11 15:07:47.721 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:47.724 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-type"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:47.724 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-type"
    inputTokens: 220
    outputTokens: 32
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:47.733 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-build"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:47.733 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-build"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:48.747 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-build"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:48.747 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-build"
    toolName: "build_knowledge_base_workflow"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:07:48.748 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-build"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:48.748 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-build"
    inputTokens: 220
    outputTokens: 34
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:48.755 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-missing-params"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:48.755 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-missing-params"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mbuild_knowledge_base_workflow[2m > [22m[2mshould build workflow with enriched data
[22m[39m[DirectAgentService] Executing MCP tool: build_knowledge_base_workflow

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=14
[STREAM] content_block_stop (text): index=0, text_len=14, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m34[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m254[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-build'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mbuild_knowledge_base_workflow[2m > [22m[2mshould reject missing required parameters
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=build_knowledge_base_workflow, id=tool-use-1765483668753
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-missing-params'[39m,
  turnCount: [33m1[39m
}

 [32mΓ£ô[39m src/__tests__/unit/services/queue/MessageQueue.embedding.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 496[2mms[22m[39m
 [32mΓ£ô[39m src/__tests__/unit/MockAnthropicClient.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 1691[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m MockAnthropicClient[2m > [22mInterface Compliance[2m > [22mreturns correct event types in streaming [33m843[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m MockAnthropicClient[2m > [22mStreaming Behavior[2m > [22mstreams events asynchronously [33m812[2mms[22m[39m
[90mstdout[2m | src/__tests__/integration/FilenameMojibake.test.ts
[22m[39m[dotenv@17.2.3] injecting env (52) from .env -- tip: ≡ƒöÉ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | src/__tests__/integration/FileUploadUnicode.test.ts[2m > [22m[2mUnicode File Upload Integration
[22m[39m≡ƒöî Connecting to Azure SQL Database... (attempt 1/10)

[2025-12-11 15:07:49.765 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-missing-params"
    category: "ai"
    eventType: "tool_executed"
    quantity: 2
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:49.765 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-missing-params"
    toolName: "build_knowledge_base_workflow"
    durationMs: 2
    error: "Database pool not initialized"
[2025-12-11 15:07:49.765 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:49.765 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-missing-params"
    turnCount: 1
    userId: "user-123"
    toolUseId: "tool-use-1765483668753"
    toolName: "build_knowledge_base_workflow"
    updateSuccess: true
    error: "workflow_name and steps are required"
[2025-12-11 15:07:49.765 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:49.766 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-missing-params"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:49.766 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-missing-params"
    inputTokens: 220
    outputTokens: 32
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:49.773 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-docs"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:49.773 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-docs"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mbuild_knowledge_base_workflow[2m > [22m[2mshould reject missing required parameters
[22m[39m[DirectAgentService] Executing MCP tool: build_knowledge_base_workflow

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=5
[STREAM] content_block_stop (text): index=0, text_len=5, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=2
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m32[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m252[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-missing-params'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mget_endpoint_documentation[2m > [22m[2mshould get endpoint documentation
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"operation_id":"listCustomers"}
[STREAM] content_block_stop (tool_use): index=0, tool=get_endpoint_documentation, id=tool-use-1765483669772
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-docs'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mget_endpoint_documentation[2m > [22m[2mshould get endpoint documentation
[22m[39m[DirectAgentService] Executing MCP tool: get_endpoint_documentation

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=13
[STREAM] content_block_stop (text): index=0, text_len=13, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m34[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m254[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-docs'[39m,
  turnCount: [33m2[39m
}

[2025-12-11 15:07:50.785 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-docs"
    category: "ai"
    eventType: "tool_executed"
    quantity: 5
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:50.786 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-docs"
    toolName: "get_endpoint_documentation"
    durationMs: 5
    error: "Database pool not initialized"
[2025-12-11 15:07:50.787 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-docs"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:50.787 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-docs"
    inputTokens: 220
    outputTokens: 34
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:50.797 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:50.798 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:51.803 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown"
    category: "ai"
    eventType: "tool_executed"
    quantity: 2
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:51.804 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown"
    toolName: "get_endpoint_documentation"
    durationMs: 2
    error: "Database pool not initialized"
[2025-12-11 15:07:51.804 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:51.804 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-unknown"
    turnCount: 1
    userId: "user-123"
    toolUseId: "tool-use-1765483670795"
    toolName: "get_endpoint_documentation"
    updateSuccess: true
    error: "Operation ID \"unknownOperation\" not found"
[2025-12-11 15:07:51.804 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:51.806 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:51.806 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown"
    inputTokens: 220
    outputTokens: 33
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:51.813 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown-tool"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:51.813 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown-tool"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/integration/FileUploadUnicode.test.ts[2m > [22m[2mUnicode File Upload Integration
[22m[39mΓ£à Database connection verified (SELECT 1 successful)
Γ£à Connected to Azure SQL Database

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mget_endpoint_documentation[2m > [22m[2mshould handle unknown operation ID
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"operation_id":"unknownOperation"}
[STREAM] content_block_stop (tool_use): index=0, tool=get_endpoint_documentation, id=tool-use-1765483670795
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-unknown'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mget_endpoint_documentation[2m > [22m[2mshould handle unknown operation ID
[22m[39m[DirectAgentService] Executing MCP tool: get_endpoint_documentation

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=9
[STREAM] content_block_stop (text): index=0, text_len=9, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=3
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m33[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m253[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-unknown'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mUnknown tool handling[2m > [22m[2mshould handle unknown tool gracefully
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"data":"test"}
[STREAM] content_block_stop (tool_use): index=0, tool=completely_unknown_tool, id=tool-use-1765483671811
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-unknown-tool'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMCP Tool Implementations[2m > [22m[2mUnknown tool handling[2m > [22m[2mshould handle unknown tool gracefully
[22m[39m[DirectAgentService] Executing MCP tool: completely_unknown_tool

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=9
[STREAM] content_block_stop (text): index=0, text_len=9, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=3
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m33[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m253[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-unknown-tool'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mExtended Thinking[2m > [22m[2mshould handle thinking blocks and emit thinking_chunk events
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-thinking, model=claude-sonnet-4, input_tokens=150, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=thinking
[STREAM] thinking_delta: index=0, chunk_len=32
[STREAM] content_block_stop (thinking): index=0, content_len=32, has_sig=false, estimated_tokens=8
[STREAM] content_block_start: index=1, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=1, chunk_len=41
[STREAM] content_block_stop (text): index=1, text_len=41, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=19
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-thinking'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m150[39m,
  outputTokens: [33m19[39m,
  thinkingTokens: [33m8[39m,
  totalTokens: [33m169[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-thinking'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mExtended Thinking[2m > [22m[2mshould not emit thinking events when thinking is disabled
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=15
[STREAM] content_block_stop (text): index=0, text_len=15, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m4[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m104[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-no-thinking'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mStop Reasons[2m > [22m[2mshould handle stop_sequence stop reason
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-stop-seq, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=19
[STREAM] content_block_stop (text): index=0, text_len=19, citations=0
[STREAM] message_delta: stop_reason=stop_sequence
[STREAM] message_delta: output_tokens=10
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=stop_sequence, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-stop-seq'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m10[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m110[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-stop-seq'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mStop Reasons[2m > [22m[2mshould handle pause_turn stop reason
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-pause, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=20
[STREAM] content_block_stop (text): index=0, text_len=20, citations=0
[STREAM] message_delta: stop_reason=pause_turn
[STREAM] message_delta: output_tokens=10
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=pause_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-pause'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m10[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m110[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-pause'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mStop Reasons[2m > [22m[2mshould handle refusal stop reason
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-refusal, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=23
[STREAM] content_block_stop (text): index=0, text_len=23, citations=0
[STREAM] message_delta: stop_reason=refusal
[STREAM] message_delta: output_tokens=10
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=refusal, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-refusal'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m10[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m110[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-refusal'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mStop Reasons[2m > [22m[2mshould handle unknown stop reason gracefully
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-unknown, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=8
[STREAM] content_block_stop (text): index=0, text_len=8, citations=0
[STREAM] message_delta: stop_reason=future_unknown_reason
[STREAM] message_delta: output_tokens=10
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=future_unknown_reason, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-unknown'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m10[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m110[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-unknown-stop'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mStop Reasons[2m > [22m[2mshould handle max_tokens and emit truncation message
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-max-tokens, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=21
[STREAM] content_block_stop (text): index=0, text_len=21, citations=0
[STREAM] message_delta: stop_reason=max_tokens
[STREAM] message_delta: output_tokens=4096
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=max_tokens, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-max-tokens'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m4096[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m4196[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-tokens'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mCitations Handling[2m > [22m[2mshould accumulate citations from citations_delta events
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-citation, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=25
[STREAM] citations_delta: index=0, type=char_location, total_citations=1
[STREAM] content_block_stop (text): index=0, text_len=25, citations=1
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=10
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-citation'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m10[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m110[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-citations'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mToken Tracking[2m > [22m[2mshould track cache creation and read tokens
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-cache, model=claude-sonnet-4, input_tokens=100, cache_read=200, cache_create=500
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=15
[STREAM] content_block_stop (text): index=0, text_len=15, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=10
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-cache'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m10[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m110[39m,
  cacheCreationInputTokens: [33m500[39m,
  cacheReadInputTokens: [33m200[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-cache'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mToken Tracking[2m > [22m[2mshould track service tier from usage
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tier, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=17
[STREAM] content_block_stop (text): index=0, text_len=17, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=10
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-tier'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m10[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m110[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [32m'priority'[39m,
  sessionId: [32m'session-tier'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle stream creation error
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle content_block_delta for unknown index
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-bad-index, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=0
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=0, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-bad-index'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m0[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m100[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-bad-index'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle content_block_stop for unknown index
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-bad-stop, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=0
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=0, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-bad-stop'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m0[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m100[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-bad-stop'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mApproval Flow[2m > [22m[2mshould require approval for write operations and proceed when approved
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"name":"New Customer"}
[STREAM] content_block_stop (tool_use): index=0, tool=create_customer, id=tool-use-1765483672931
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-approval-yes'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:52.819 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown-tool"
    category: "ai"
    eventType: "tool_executed"
    quantity: 2
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:52.819 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown-tool"
    toolName: "completely_unknown_tool"
    durationMs: 2
    error: "Database pool not initialized"
[2025-12-11 15:07:52.819 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:52.819 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-unknown-tool"
    turnCount: 1
    userId: "user-123"
    toolUseId: "tool-use-1765483671811"
    toolName: "completely_unknown_tool"
    updateSuccess: true
    error: "Unknown tool: completely_unknown_tool"
[2025-12-11 15:07:52.819 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:52.820 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown-tool"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:52.820 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown-tool"
    inputTokens: 220
    outputTokens: 33
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.829 -0500] [33mWARN[39m: [36mundefined - ≡ƒºá [THINKING] Block completed but NOT added to history (missing content or signature)[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-thinking"
    turnCount: 1
    eventIndex: 0
    hasContent: true
    hasSignature: false
[2025-12-11 15:07:52.830 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-thinking"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 150
    unit: "tokens"
    cost: 0.00045
    error: "Database pool not initialized"
[2025-12-11 15:07:52.830 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-thinking"
    inputTokens: 150
    outputTokens: 19
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.839 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-no-thinking"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:52.839 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-no-thinking"
    inputTokens: 100
    outputTokens: 4
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.848 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-stop-seq"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:52.848 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-stop-seq"
    inputTokens: 100
    outputTokens: 10
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.854 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-pause"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:52.854 -0500] [33mWARN[39m: [36mundefined - ΓÅ╕∩╕Å [PAUSE_TURN] Agentic turn paused by Claude[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-pause"
    turnCount: 1
    stopReason: "pause_turn"
    accumulatedTextLength: 20
[2025-12-11 15:07:52.854 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-pause"
    inputTokens: 100
    outputTokens: 10
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.860 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-refusal"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:52.861 -0500] [33mWARN[39m: [36mundefined - ≡ƒÜ½ [REFUSAL] Content refused due to policy violation[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-refusal"
    turnCount: 1
    stopReason: "refusal"
    accumulatedTextLength: 23
[2025-12-11 15:07:52.861 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-refusal"
    inputTokens: 100
    outputTokens: 10
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.868 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown-stop"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:52.868 -0500] [33mWARN[39m: [36mundefined - ΓÜá∩╕Å [UNKNOWN_STOP_REASON] Unhandled stop reason, terminating loop[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-unknown-stop"
    turnCount: 1
    stopReason: "future_unknown_reason"
[2025-12-11 15:07:52.868 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-unknown-stop"
    inputTokens: 100
    outputTokens: 10
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.873 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-tokens"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:52.873 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-tokens"
    inputTokens: 100
    outputTokens: 4096
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.880 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-citations"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:52.880 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-citations"
    inputTokens: 100
    outputTokens: 10
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.885 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-cache"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:52.886 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-cache"
    inputTokens: 100
    outputTokens: 10
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.893 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-tier"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:52.893 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-tier"
    inputTokens: 100
    outputTokens: 10
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.908 -0500] [31mERROR[39m: [36mundefined - Γ¥î Stream creation failed[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-stream-error"
    turnCount: 1
    errorType: "Error"
    stack: "Error: Stream creation failed\n    at Object.<anonymous> (D:\Documents\BC-Claude-Agent-prototype\backend\src\__tests__\unit\services\agent\DirectAgentService.comprehensive.test.ts:1352:15)\n    at Object.mockCall (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/spy/dist/index.js:61:17)\n    at Object.spy [as createChatCompletionStream] (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/tinyspy/dist/index.js:45:80)\n    at DirectAgentService.executeQueryStreaming (D:\Documents\BC-Claude-Agent-prototype\backend\src\services\agent\DirectAgentService.ts:481:32)\n    at D:\Documents\BC-Claude-Agent-prototype\backend\src\__tests__\unit\services\agent\DirectAgentService.comprehensive.test.ts:1355:22\n    at file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:533:5\n    at runTest (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:1056:11)\n    at runSuite (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:1205:15)\n    at runSuite (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:1205:15)\n    at runSuite (file:///D:/Documents/BC-Claude-Agent-prototype/node_modules/@vitest/runner/dist/index.js:1205:15)"
    error: "Stream creation failed"
[2025-12-11 15:07:52.915 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-bad-index"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:52.915 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-bad-index"
    inputTokens: 100
    outputTokens: 0
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.926 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-bad-stop"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:52.926 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-bad-stop"
    inputTokens: 100
    outputTokens: 0
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:52.933 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-approval-yes"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:52.933 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-approval-yes"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mApproval Flow[2m > [22m[2mshould require approval for write operations and proceed when approved
[22m[39m[DirectAgentService] Executing MCP tool: create_customer

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=16
[STREAM] content_block_stop (text): index=0, text_len=16, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m34[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m254[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-approval-yes'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mApproval Flow[2m > [22m[2mshould cancel operation when approval is denied
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] input_json_delta: index=0, parsed_input={"id":"123"}
[STREAM] content_block_stop (tool_use): index=0, tool=delete_customer, id=tool-use-1765483673956
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-approval-no'[39m,
  turnCount: [33m1[39m
}

[2025-12-11 15:07:53.951 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-approval-yes"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:53.951 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-approval-yes"
    toolName: "create_customer"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:07:53.951 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result event (error) appended to EventStore[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:53.951 -0500] [31mERROR[39m: [36mundefined - ≡ƒöì [TRACE 8/8] After MessageService.updateToolResult - ERROR[39m
    env: "test"
    service: "DirectAgentService"
    sessionId: "session-approval-yes"
    turnCount: 1
    userId: "user-123"
    toolUseId: "tool-use-1765483672931"
    toolName: "create_customer"
    updateSuccess: true
    error: "Unknown tool: create_customer"
[2025-12-11 15:07:53.951 -0500] [31mERROR[39m: [36mundefined - Γ¥î Tool result message (error) queued for persistence[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:53.951 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-approval-yes"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:53.951 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-approval-yes"
    inputTokens: 220
    outputTokens: 34
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:53.957 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-approval-no"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:53.957 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-approval-no"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mApproval Flow[2m > [22m[2mshould cancel operation when approval is denied
[22m[39m
========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=19
[STREAM] content_block_stop (text): index=0, text_len=19, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=5
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m35[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m255[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-approval-no'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mApproval Flow[2m > [22m[2mshould not require approval for read operations
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483674980
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-read'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts[2m > [22m[2mPerformance Tests[2m > [22m[2mMemory Safety[2m > [22m[2mshould not accumulate excessive heap or RSS after 500 log batch requests
[22m[39m[PERF] Memory after 500 log batches:
  - Initial heap: 49.36MB
  - Final heap: 82.60MB
  - Heap growth: 33.24MB (threshold: 100MB)
  - Initial RSS: 128.49MB
  - Final RSS: 174.09MB
  - RSS growth: 45.60MB (threshold: 150MB)
  - Max growth: 45.60MB

[2025-12-11 15:07:54.971 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-approval-no"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:54.971 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-approval-no"
    inputTokens: 220
    outputTokens: 35
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:54.983 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-read"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:54.983 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-read"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:55.993 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-read"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:55.994 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-read"
    toolName: "list_all_entities"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:07:55.995 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-read"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 220
    unit: "tokens"
    cost: 0.00066
    error: "Database pool not initialized"
[2025-12-11 15:07:55.995 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-read"
    inputTokens: 220
    outputTokens: 34
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:56.003 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-cache"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:56.003 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-cache"
    inputTokens: 100
    outputTokens: 2
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:56.092 -0500] [31mERROR[39m: [36mundefined - ≡ƒÜ¿ SDK NO proporcion├│ tool use ID - usando fallback[39m
    env: "test"
    service: "DirectAgentService"
[2025-12-11 15:07:56.092 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-bad-tool-id"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 100
    unit: "tokens"
    cost: 0.00030000000000000003
    error: "Database pool not initialized"
[2025-12-11 15:07:56.093 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-bad-tool-id"
    inputTokens: 100
    outputTokens: 10
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mApproval Flow[2m > [22m[2mshould not require approval for read operations
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=15
[STREAM] content_block_stop (text): index=0, text_len=15, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=4
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m220[39m,
  outputTokens: [33m34[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m254[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-read'[39m,
  turnCount: [33m2[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mSystem Prompt Caching[2m > [22m[2mshould use array with cache_control when ENABLE_PROMPT_CACHING is true
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=8
[STREAM] content_block_stop (text): index=0, text_len=8, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=2
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m2[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m102[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-cache'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mTool Use ID Validation[2m > [22m[2mshould use fallback ID when SDK provides invalid tool_use_id
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-bad-tool-id, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=toolu_fallback_59baaae2-b1bc-4812-b774-d190ccaf87ed
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=10
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-bad-tool-id'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m100[39m,
  outputTokens: [33m10[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m110[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-bad-tool-id'[39m,
  turnCount: [33m1[39m
}

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mTool Use ID Validation[2m > [22m[2mshould use fallback ID when SDK provides invalid tool_use_id
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-test, model=claude-sonnet-4, input_tokens=100, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=text
≡ƒôª [SEQUENCE] chunk (transient) | NO sequence, chunk=1
[STREAM] text_delta: index=0, chunk_len=4
[STREAM] content_block_stop (text): index=0, text_len=4, citations=0
[STREAM] message_delta: stop_reason=end_turn
[STREAM] message_delta: output_tokens=1
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=end_turn, thinking_blocks=0, text_blocks=1, tool_uses=0
[TOKEN TRACKING] {
  messageId: [32m'msg-test'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m200[39m,
  outputTokens: [33m11[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m211[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-bad-tool-id'[39m,
  turnCount: [33m2[39m
}

[2025-12-11 15:07:57.105 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-bad-tool-id"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:57.105 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-bad-tool-id"
    toolName: "list_all_entities"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:07:57.105 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-bad-tool-id"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 200
    unit: "tokens"
    cost: 0.0006000000000000001
    error: "Database pool not initialized"
[2025-12-11 15:07:57.105 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-bad-tool-id"
    inputTokens: 200
    outputTokens: 11
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:07:57.109 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 120
    unit: "tokens"
    cost: 0.00036
    error: "Database pool not initialized"
[2025-12-11 15:07:57.109 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 120
    outputTokens: 30
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m
========== TURN 1 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 1 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483677109
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m120[39m,
  outputTokens: [33m30[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m150[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m1[39m
}

 [32mΓ£ô[39m src/__tests__/integration/FilenameMojibake.test.ts [2m([22m[2m5 tests[22m[2m)[22m[90m 5[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 2 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 2 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483678117
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m240[39m,
  outputTokens: [33m60[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m300[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m2[39m
}

[2025-12-11 15:07:58.116 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:58.116 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:58.117 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 240
    unit: "tokens"
    cost: 0.00072
    error: "Database pool not initialized"
[2025-12-11 15:07:58.117 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 240
    outputTokens: 60
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts[2m > [22m[2mPerformance Tests[2m > [22m[2mMemory Safety[2m > [22m[2mshould not leak memory with complex context objects (heap + RSS)
[22m[39m[PERF] Memory after 200 complex context requests:
  - Heap growth: 22.57MB (threshold: 80MB)
  - RSS growth: 27.28MB (threshold: 150MB)

[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts[2m > [22m[2mPerformance Tests[2m > [22m[2mLarge Batch Processing[2m > [22m[2mshould handle maximum batch size (100 logs) within batch threshold
[22m[39m[PERF] Max batch (100 logs): 19ms (threshold: 1000ms)

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 3 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 3 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483679125
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m360[39m,
  outputTokens: [33m90[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m450[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m3[39m
}

[2025-12-11 15:07:58.159 -0500] [31mERROR[39m (1234567890123-test-file.pdf): [36mundefined - Invalid file name: looks like blob path[39m
    env: "test"
    service: "FileService"
    blobPath: "users/ed64bf4f-4063-4161-a723-971e6c2495c6/files/1234567890123-test-file.pdf"
[2025-12-11 15:07:58.824 -0500] [31mERROR[39m (users/test/files/document.pdf): [36mundefined - Invalid file name: looks like blob path[39m
    env: "test"
    service: "FileService"
    blobPath: "users/07c4c32a-5cef-47ba-b54f-b9466b3b39d2/files/1234567890126-document.pdf"
[2025-12-11 15:07:59.124 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:59.125 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:07:59.125 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 360
    unit: "tokens"
    cost: 0.00108
    error: "Database pool not initialized"
[2025-12-11 15:07:59.126 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 360
    outputTokens: 90
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[2025-12-11 15:08:00.140 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:00.140 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:00.141 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 480
    unit: "tokens"
    cost: 0.00144
    error: "Database pool not initialized"
[2025-12-11 15:08:00.141 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 480
    outputTokens: 120
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts[2m > [22m[2mPerformance Tests[2m > [22m[2mLarge Batch Processing[2m > [22m[2mshould process 10 concurrent max-size batches with SLA compliance
[22m[39m[PERF] 10 concurrent max-size batches:
  - Total duration: 147ms (threshold: 5000ms)
  - Max single batch: 138.00ms
  - All successful: true

[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 4 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 4 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483680140
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m480[39m,
  outputTokens: [33m120[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m600[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m4[39m
}

[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts[2m > [22m[2mPerformance Tests[2m > [22m[2mError Handling Under Load[2m > [22m[2mshould gracefully handle validation errors under concurrent load
[22m[39m[PERF] 50 concurrent validation errors:
  - All returned 400: true
  - Avg response: 404.80ms

[90mstdout[2m | src/__tests__/unit/routes/performance.test.ts[2m > [22m[2mPerformance Tests[2m > [22m[2mError Handling Under Load[2m > [22m[2mshould maintain stability when service throws errors
[22m[39m[PERF] 50 concurrent with service errors:
  - All completed: true
  - Avg response: 381.88ms

 [32mΓ£ô[39m src/__tests__/unit/routes/performance.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 21379[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Performance Tests[2m > [22mConcurrent Request Handling[2m > [22mshould handle 100 concurrent token-usage/me requests with SLA compliance [33m1874[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Performance Tests[2m > [22mConcurrent Request Handling[2m > [22mshould handle 100 concurrent log batch requests with SLA compliance [33m2232[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Performance Tests[2m > [22mConcurrent Request Handling[2m > [22mshould handle multi-tenant concurrent access with data isolation verification [33m1800[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Performance Tests[2m > [22mResponse Time Validation[2m > [22mshould maintain SLA-compliant response times under moderate load [33m823[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Performance Tests[2m > [22mMemory Safety[2m > [22mshould not accumulate excessive heap or RSS after 500 log batch requests [33m10788[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Performance Tests[2m > [22mMemory Safety[2m > [22mshould not leak memory with complex context objects (heap + RSS) [33m2578[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Performance Tests[2m > [22mError Handling Under Load[2m > [22mshould gracefully handle validation errors under concurrent load [33m496[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Performance Tests[2m > [22mError Handling Under Load[2m > [22mshould maintain stability when service throws errors [33m486[2mms[22m[39m
[90mstdout[2m | src/__tests__/integration/FileUploadUnicode.test.ts[2m > [22m[2mUnicode File Upload Integration
[22m[39mΓ£à Database connection closed

 [32mΓ£ô[39m src/__tests__/integration/FileUploadUnicode.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 11207[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Unicode File Upload Integration[2m > [22mshould store original Unicode filename in database [33m1880[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Unicode File Upload Integration[2m > [22mshould preserve Danish characters (├ª, ├╕, ├Ñ) [33m1632[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Unicode File Upload Integration[2m > [22mshould preserve emoji and special symbols [33m1613[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Unicode File Upload Integration[2m > [22mshould reject blob path as filename [33m650[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Unicode File Upload Integration[2m > [22mshould reject filename containing "users/" path [33m671[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m Unicode File Upload Integration[2m > [22mshould handle long Unicode filenames [33m1630[2mms[22m[39m
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 5 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 5 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483681153
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m600[39m,
  outputTokens: [33m150[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m750[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m5[39m
}

[2025-12-11 15:08:01.151 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:01.151 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:08:01.153 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 600
    unit: "tokens"
    cost: 0.0018
    error: "Database pool not initialized"
[2025-12-11 15:08:01.153 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 600
    outputTokens: 150
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 6 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 6 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483682157
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m720[39m,
  outputTokens: [33m180[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m900[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m6[39m
}

[2025-12-11 15:08:02.157 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:02.157 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:08:02.157 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 720
    unit: "tokens"
    cost: 0.00216
    error: "Database pool not initialized"
[2025-12-11 15:08:02.157 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 720
    outputTokens: 180
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 7 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 7 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483683171
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m840[39m,
  outputTokens: [33m210[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1050[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m7[39m
}

[2025-12-11 15:08:03.170 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:03.170 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:03.171 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 840
    unit: "tokens"
    cost: 0.00252
    error: "Database pool not initialized"
[2025-12-11 15:08:03.172 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 840
    outputTokens: 210
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 8 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 8 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483684190
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m960[39m,
  outputTokens: [33m240[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1200[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m8[39m
}

[2025-12-11 15:08:04.189 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:04.189 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:08:04.190 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 960
    unit: "tokens"
    cost: 0.00288
    error: "Database pool not initialized"
[2025-12-11 15:08:04.190 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 960
    outputTokens: 240
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 9 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 9 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483685197
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1080[39m,
  outputTokens: [33m270[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1350[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m9[39m
}

[2025-12-11 15:08:05.197 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:05.197 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:08:05.198 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1080
    unit: "tokens"
    cost: 0.0032400000000000003
    error: "Database pool not initialized"
[2025-12-11 15:08:05.198 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 1080
    outputTokens: 270
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 10 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 10 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483686200
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1200[39m,
  outputTokens: [33m300[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1500[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m10[39m
}

[2025-12-11 15:08:06.200 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:06.200 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:08:06.201 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1200
    unit: "tokens"
    cost: 0.0036
    error: "Database pool not initialized"
[2025-12-11 15:08:06.201 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 1200
    outputTokens: 300
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 11 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 11 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483687213
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1320[39m,
  outputTokens: [33m330[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1650[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m11[39m
}

[2025-12-11 15:08:07.213 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:07.213 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:08:07.214 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1320
    unit: "tokens"
    cost: 0.00396
    error: "Database pool not initialized"
[2025-12-11 15:08:07.214 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 1320
    outputTokens: 330
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 12 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 12 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483688221
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1440[39m,
  outputTokens: [33m360[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1800[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m12[39m
}

[2025-12-11 15:08:08.220 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:08.221 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:08.221 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1440
    unit: "tokens"
    cost: 0.00432
    error: "Database pool not initialized"
[2025-12-11 15:08:08.221 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 1440
    outputTokens: 360
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 13 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 13 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483689233
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1560[39m,
  outputTokens: [33m390[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m1950[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m13[39m
}

[2025-12-11 15:08:09.233 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:09.233 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:09.233 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1560
    unit: "tokens"
    cost: 0.00468
    error: "Database pool not initialized"
[2025-12-11 15:08:09.233 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 1560
    outputTokens: 390
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 14 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 14 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483690238
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1680[39m,
  outputTokens: [33m420[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m2100[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m14[39m
}

[2025-12-11 15:08:10.238 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:10.238 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:10.238 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1680
    unit: "tokens"
    cost: 0.00504
    error: "Database pool not initialized"
[2025-12-11 15:08:10.238 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 1680
    outputTokens: 420
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 15 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 15 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483691246
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1800[39m,
  outputTokens: [33m450[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m2250[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m15[39m
}

[2025-12-11 15:08:11.245 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:11.246 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:11.246 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1800
    unit: "tokens"
    cost: 0.0054
    error: "Database pool not initialized"
[2025-12-11 15:08:11.248 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 1800
    outputTokens: 450
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 16 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 16 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483692257
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m1920[39m,
  outputTokens: [33m480[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m2400[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m16[39m
}

[2025-12-11 15:08:12.257 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:12.257 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:08:12.257 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 1920
    unit: "tokens"
    cost: 0.00576
    error: "Database pool not initialized"
[2025-12-11 15:08:12.258 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 1920
    outputTokens: 480
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 17 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 17 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483693268
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m2040[39m,
  outputTokens: [33m510[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m2550[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m17[39m
}

[2025-12-11 15:08:13.268 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:13.268 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:13.268 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 2040
    unit: "tokens"
    cost: 0.0061200000000000004
    error: "Database pool not initialized"
[2025-12-11 15:08:13.268 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 2040
    outputTokens: 510
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 18 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 18 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483694282
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m2160[39m,
  outputTokens: [33m540[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m2700[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m18[39m
}

[2025-12-11 15:08:14.281 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:14.281 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:14.282 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 2160
    unit: "tokens"
    cost: 0.0064800000000000005
    error: "Database pool not initialized"
[2025-12-11 15:08:14.282 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 2160
    outputTokens: 540
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 19 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 19 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483695285
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m2280[39m,
  outputTokens: [33m570[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m2850[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m19[39m
}

[2025-12-11 15:08:15.285 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 1
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:15.285 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 1
    error: "Database pool not initialized"
[2025-12-11 15:08:15.286 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 2280
    unit: "tokens"
    cost: 0.006840000000000001
    error: "Database pool not initialized"
[2025-12-11 15:08:15.286 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 2280
    outputTokens: 570
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

========== TURN 20 (STREAMING) ==========
≡ƒôí [SEQUENCE] Starting turn 20 | NO batch sequence (chunks transient)
[STREAM] message_start: id=msg-tool, model=claude-sonnet-4, input_tokens=120, cache_read=0, cache_create=0
[STREAM] content_block_start: index=0, type=tool_use
[STREAM] content_block_stop (tool_use): index=0, tool=list_all_entities, id=tool-use-1765483696302
[STREAM] message_delta: stop_reason=tool_use
[STREAM] message_delta: output_tokens=30
[STREAM] message_stop
[STREAM] Stream completed: stop_reason=tool_use, thinking_blocks=0, text_blocks=0, tool_uses=1
[TOKEN TRACKING] {
  messageId: [32m'msg-tool'[39m,
  model: [32m'claude-sonnet-4'[39m,
  inputTokens: [33m2400[39m,
  outputTokens: [33m600[39m,
  thinkingTokens: [33m0[39m,
  totalTokens: [33m3000[39m,
  cacheCreationInputTokens: [33m0[39m,
  cacheReadInputTokens: [33m0[39m,
  serviceTier: [90mundefined[39m,
  sessionId: [32m'session-max-turns'[39m,
  turnCount: [33m20[39m
}

[2025-12-11 15:08:16.301 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "tool_executed"
    quantity: 0
    unit: "milliseconds"
    cost: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:16.301 -0500] [31mERROR[39m: [36mundefined - Failed to track tool execution (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    toolName: "list_all_entities"
    durationMs: 0
    error: "Database pool not initialized"
[2025-12-11 15:08:16.302 -0500] [31mERROR[39m: [36mundefined - Failed to insert usage event into database[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    category: "ai"
    eventType: "claude_input_tokens"
    quantity: 2400
    unit: "tokens"
    cost: 0.0072
    error: "Database pool not initialized"
[2025-12-11 15:08:16.302 -0500] [31mERROR[39m: [36mundefined - Failed to track Claude usage (non-blocking)[39m
    env: "test"
    service: "UsageTrackingService"
    userId: "user-123"
    sessionId: "session-max-turns"
    inputTokens: 2400
    outputTokens: 600
    model: "claude-sonnet-4"
    error: "Database pool not initialized"
[90mstdout[2m | src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts[2m > [22m[2mDirectAgentService - Comprehensive Tests[2m > [22m[2mMax Turns Safety[2m > [22m[2mshould emit max turns warning when limit is reached
[22m[39m[DirectAgentService] Executing MCP tool: list_all_entities

 [32mΓ£ô[39m src/__tests__/unit/services/agent/DirectAgentService.comprehensive.test.ts [2m([22m[2m55 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 42216[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mlist_all_entities[2m > [22mshould list all entities without filters [33m1308[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mlist_all_entities[2m > [22mshould filter entities by operations [33m1052[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mlist_all_entities[2m > [22mshould handle missing bc_index.json [33m1067[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22msearch_entity_operations[2m > [22mshould search entities by keyword [33m1016[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22msearch_entity_operations[2m > [22mshould apply risk level filter [33m1016[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22msearch_entity_operations[2m > [22mshould apply operation type filter [33m1019[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mget_entity_details[2m > [22mshould get entity details by name [33m1015[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mget_entity_details[2m > [22mshould handle entity not found [33m1028[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mget_entity_relationships[2m > [22mshould get entity relationships [33m1019[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mvalidate_workflow_structure[2m > [22mshould validate a valid workflow [33m1024[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mvalidate_workflow_structure[2m > [22mshould handle invalid operation IDs [33m1022[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mvalidate_workflow_structure[2m > [22mshould reject non-array workflow parameter [33m1029[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mbuild_knowledge_base_workflow[2m > [22mshould build workflow with enriched data [33m1023[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mbuild_knowledge_base_workflow[2m > [22mshould reject missing required parameters [33m1018[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mget_endpoint_documentation[2m > [22mshould get endpoint documentation [33m1023[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mget_endpoint_documentation[2m > [22mshould handle unknown operation ID [33m1017[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMCP Tool Implementations[2m > [22mUnknown tool handling[2m > [22mshould handle unknown tool gracefully [33m1014[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mApproval Flow[2m > [22mshould require approval for write operations and proceed when approved [33m1025[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mApproval Flow[2m > [22mshould cancel operation when approval is denied [33m1022[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mApproval Flow[2m > [22mshould not require approval for read operations [33m1024[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mTool Use ID Validation[2m > [22mshould use fallback ID when SDK provides invalid tool_use_id [33m1018[2mms[22m[39m
   [33m[2mΓ£ô[22m[39m DirectAgentService - Comprehensive Tests[2m > [22mMax Turns Safety[2m > [22mshould emit max turns warning when limit is reached [33m20214[2mms[22m[39m

[2m Test Files [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m72 passed[39m[22m[90m (73)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[2m | [22m[1m[32m1840 passed[39m[22m[2m | [22m[33m13 skipped[39m[90m (1854)[39m
[2m   Start at [22m 15:07:28
[2m   Duration [22m 48.82s[2m (transform 25.17s, setup 34.20s, collect 94.10s, tests 116.86s, environment 121ms, prepare 30.28s)[22m

