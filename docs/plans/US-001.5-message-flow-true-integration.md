# US-001.5: Reescribir message-flow como Test de Integración Real

**Epic**: Infraestructura de Tests
**Prioridad**: P0 - Bloqueante (requisito para cerrar US-001)
**Origen**: Hallazgo de QA durante validación de US-001
**Afecta**: message-flow.integration.test.ts
**Tests a Rehabilitar**: 8 tests
**Estimación**: 2-4 horas

---

## Contexto del Hallazgo

### Descubrimiento durante QA de US-001

Durante la validación de criterios de aceptación de US-001, se identificó que `message-flow.integration.test.ts` fue **EXCLUIDO** de la suite de integración en lugar de ser **REHABILITADO**.

**vitest.integration.config.ts:41-48:**
```typescript
exclude: [
  'node_modules',
  'dist',
  'mcp-server',
  // Exclude tests that use vi.mock on infrastructure modules
  // These should be in functional/ or unit/ instead
  'src/__tests__/integration/websocket/message-flow.integration.test.ts',
],
```

### Causa Raíz

El archivo `message-flow.integration.test.ts` contiene **4 mocks de infraestructura** que contaminan el module cache de Vitest y causan race conditions con otros tests de integración:

| Mock | Líneas | Impacto |
|------|--------|---------|
| `@/services/agent/DirectAgentService` | 32-104 | Simula agente completo |
| `@/config/database` | 109-122 | Mock de executeQuery |
| `@/services/messages/MessageService` | 125-135 | Mock de persistencia |
| `@/utils/session-ownership` | 138-140 | Mock de validación |

**Esto viola el principio de un test de integración**: debe usar infraestructura REAL (Redis, SQL) para validar comportamiento end-to-end.

---

## Descripción

Como **desarrollador**, necesito que el test `message-flow.integration.test.ts` use infraestructura real (Redis, Azure SQL, FakeAnthropicClient), para que valide el flujo completo de mensajes sin mocks de infraestructura que contaminen otros tests.

---

## Problema Actual

### Arquitectura Incorrecta (Estado Actual)

```
┌─────────────────────────────────────────────────────────────┐
│                    message-flow.test.ts                      │
├─────────────────────────────────────────────────────────────┤
│  vi.mock('@/services/agent/DirectAgentService')             │ ← MOCK
│  vi.mock('@/config/database')                               │ ← MOCK
│  vi.mock('@/services/messages/MessageService')              │ ← MOCK
│  vi.mock('@/utils/session-ownership')                       │ ← MOCK
├─────────────────────────────────────────────────────────────┤
│  Redis: REAL (Docker localhost:6399)                        │ ← REAL
│  Socket.IO: REAL (Test server)                              │ ← REAL
└─────────────────────────────────────────────────────────────┘
```

**Problema**: Los mocks de `@/config/database` contaminan el module cache. Cuando Vitest ejecuta otros tests que necesitan la base de datos REAL, obtienen la versión mockeada, causando:
- `Database not connected. Call initDatabase() first.`
- Race conditions intermitentes
- Tests que pasan solos pero fallan en suite completa

### Arquitectura Correcta (Objetivo)

```
┌─────────────────────────────────────────────────────────────┐
│                    message-flow.test.ts                      │
├─────────────────────────────────────────────────────────────┤
│  DirectAgentService con FakeAnthropicClient                 │ ← DI
│  Database: REAL (Azure SQL)                                 │ ← REAL
│  MessageService: REAL                                       │ ← REAL
│  session-ownership: REAL                                    │ ← REAL
├─────────────────────────────────────────────────────────────┤
│  Redis: REAL (Docker localhost:6399)                        │ ← REAL
│  Socket.IO: REAL (Test server)                              │ ← REAL
└─────────────────────────────────────────────────────────────┘
```

---

## Análisis Detallado de Mocks a Eliminar

### 1. Mock de DirectAgentService (líneas 32-104)

**Estado Actual:**
```typescript
vi.mock('@/services/agent/DirectAgentService', async (importOriginal) => {
  return {
    ...original,
    getDirectAgentService: vi.fn(() => ({
      executeQueryStreaming: async (message, sessionId, onEvent, userId) => {
        // Simulación hardcodeada de eventos
        onEvent({ type: 'thinking', ... });
        onEvent({ type: 'message_chunk', ... });
        onEvent({ type: 'message', ... });
        onEvent({ type: 'complete', ... });
      },
    })),
  };
});
```

**Solución:**
DirectAgentService ya soporta inyección de dependencia via constructor:
```typescript
// backend/src/services/agent/DirectAgentService.ts:63
constructor(
  eventStore?: EventStore,
  approvalManager?: ApprovalManager,
  anthropicClient?: IAnthropicClient  // ← Usar FakeAnthropicClient aquí
)
```

**Implementación:**
```typescript
// En el test
import { FakeAnthropicClient } from '@/services/agent/FakeAnthropicClient';
import { DirectAgentService } from '@/services/agent/DirectAgentService';

const fakeClient = new FakeAnthropicClient();
fakeClient.setResponse('Hello from fake client');

const agentService = new DirectAgentService(
  getEventStore(),
  getApprovalManager(),
  fakeClient
);
```

### 2. Mock de Database (líneas 109-122)

**Estado Actual:**
```typescript
vi.mock('@/config/database', async (importOriginal) => {
  return {
    ...original,
    executeQuery: vi.fn().mockImplementation(async (query: string) => {
      if (query.includes('SELECT 1')) {
        return { recordset: [{ result: 1 }], rowsAffected: [1] };
      }
      return { recordset: [], rowsAffected: [1] };
    }),
  };
});
```

**Problema**: Este mock intercepta TODAS las queries de database, incluyendo las de otros tests que se ejecutan después.

**Solución**: Eliminar completamente. Usar `setupDatabaseForTests()` que ya existe:
```typescript
describe('WebSocket Message Flow Integration', () => {
  setupDatabaseForTests(); // Usa Azure SQL real
  // ...
});
```

### 3. Mock de MessageService (líneas 125-135)

**Estado Actual:**
```typescript
vi.mock('@/services/messages/MessageService', () => ({
  getMessageService: vi.fn(() => ({
    saveUserMessage: vi.fn().mockResolvedValue({
      messageId: `user_msg_${Date.now()}`,
      sequenceNumber: 0,
      eventId: `evt_user_${Date.now()}`,
    }),
    saveToolUseMessage: vi.fn().mockResolvedValue(undefined),
    updateToolResult: vi.fn().mockResolvedValue(undefined),
  })),
}));
```

**Solución**: Eliminar. MessageService funciona con base de datos real si está conectada.

### 4. Mock de session-ownership (líneas 138-140)

**Estado Actual:**
```typescript
vi.mock('@/utils/session-ownership', () => ({
  validateSessionOwnership: vi.fn().mockResolvedValue({ isOwner: true }),
}));
```

**Solución**: Eliminar. TestSessionFactory crea usuarios y sesiones reales que pasan validación de ownership.

---

## Criterios de Aceptación

### Para Desarrollador

| # | Criterio | Verificación |
|---|----------|--------------|
| D1 | Archivo sin `vi.mock` de infraestructura | `grep -c "vi.mock" message-flow.test.ts` = 0 |
| D2 | Usa FakeAnthropicClient via DI | Import directo, no mock |
| D3 | Usa base de datos Azure SQL real | `setupDatabaseForTests()` en describe |
| D4 | 8/8 tests pasan | `npx vitest run message-flow` |
| D5 | No contamina otros tests | Suite completa pasa |

### Para QA

| # | Criterio | Comando |
|---|----------|---------|
| Q1 | Suite completa sin errores de DB | `npm run test:integration` |
| Q2 | Tiempo total < 90s | Medir duración |
| Q3 | 3 ejecuciones consecutivas estables | Loop de validación |

---

## Tareas de Implementación

| # | Tarea | Detalle | Estimación |
|---|-------|---------|------------|
| 1.1 | Eliminar mock de DirectAgentService | Líneas 32-104 | 15 min |
| 1.2 | Implementar inyección de FakeAnthropicClient | Usar constructor de DirectAgentService | 30 min |
| 1.3 | Eliminar mock de database | Líneas 109-122 | 5 min |
| 1.4 | Eliminar mock de MessageService | Líneas 125-135 | 5 min |
| 1.5 | Eliminar mock de session-ownership | Líneas 138-140 | 5 min |
| 1.6 | Ajustar setup del test server | Usar servicios reales | 45 min |
| 1.7 | Configurar FakeAnthropicClient responses | Respuestas para cada test | 30 min |
| 1.8 | Remover de exclude[] en vitest config | Rehabilitar en suite | 5 min |
| 1.9 | Ejecutar y corregir tests | Debug y fixes | 60 min |
| 1.10 | Validación QA (3 ejecuciones) | Estabilidad | 15 min |

**Total Estimado**: 3.5 horas

---

## Solución Técnica Detallada

### Paso 1: Nuevo beforeAll con servicios reales

```typescript
// ANTES (con mocks)
beforeAll(async () => {
  // Solo setup de Redis y Socket.IO
});

// DESPUÉS (sin mocks)
import { DirectAgentService } from '@/services/agent/DirectAgentService';
import { FakeAnthropicClient } from '@/services/agent/FakeAnthropicClient';
import { getEventStore } from '@/services/events/EventStore';
import { getApprovalManager } from '@/services/agent/ApprovalManager';

let agentService: DirectAgentService;
let fakeClient: FakeAnthropicClient;

beforeAll(async () => {
  // 1. Database y Redis ya inicializados por setupDatabaseForTests()

  // 2. Crear FakeAnthropicClient
  fakeClient = new FakeAnthropicClient();

  // 3. Crear DirectAgentService con cliente fake via DI
  agentService = new DirectAgentService(
    getEventStore(),
    getApprovalManager(),
    fakeClient
  );

  // 4. Setup Socket.IO server con handler que usa nuestro agentService
  // (requiere modificar cómo se crea el chat handler)
});
```

### Paso 2: Modificar ChatMessageHandler para aceptar agentService

**Problema**: `getChatMessageHandler()` usa singleton interno.

**Solución A**: Crear factory function con parámetro opcional:
```typescript
// En ChatMessageHandler.ts
export function createChatMessageHandler(
  agentService?: DirectAgentService
): ChatMessageHandler {
  return new ChatMessageHandler(agentService ?? getDirectAgentService());
}
```

**Solución B**: Usar el singleton pero resetear el cliente fake antes de cada test.

### Paso 3: Configurar respuestas del FakeAnthropicClient

```typescript
beforeEach(() => {
  // Reset fake client para cada test
  fakeClient.reset();

  // Configurar respuesta default
  fakeClient.setResponse('Default test response');
});

it('should stream message_chunk events', async () => {
  // Configurar respuesta específica para este test
  fakeClient.setResponse('This is a streaming test response');

  // ... resto del test
});
```

### Paso 4: Remover de exclude en vitest.integration.config.ts

```typescript
exclude: [
  'node_modules',
  'dist',
  'mcp-server',
  // REMOVIDO: 'src/__tests__/integration/websocket/message-flow.integration.test.ts',
],
```

---

## Dependencias

- **Requiere**: US-001 completado (sequence-numbers rehabilitado)
- **Habilita**: Cierre completo de US-001, avance a US-002

---

## Riesgos

| Riesgo | Probabilidad | Impacto | Mitigación |
|--------|--------------|---------|------------|
| ChatMessageHandler no acepta DI | Media | Alto | Crear factory function |
| FakeAnthropicClient insuficiente | Baja | Medio | Extender si es necesario |
| Tests tardan más con DB real | Alta | Bajo | Aceptable, es integración |
| Conflictos con otros tests | Media | Alto | Ejecutar suite completa |

---

## Validación Final

### Script de Validación

```powershell
# Windows PowerShell
Write-Host "=== Validación US-001.5 ==="

# 1. Verificar sin vi.mock de infraestructura
$mockCount = (Select-String -Path "backend\src\__tests__\integration\websocket\message-flow.integration.test.ts" -Pattern "vi\.mock" | Measure-Object).Count
Write-Host "vi.mock count: $mockCount (esperado: 0)"

# 2. Ejecutar test aislado
Write-Host "`n--- Test aislado ---"
cd backend
npx vitest run --config vitest.integration.config.ts "message-flow"

# 3. Ejecutar suite completa 3 veces
for ($i=1; $i -le 3; $i++) {
  Write-Host "`n--- Ejecución $i/3 ---"
  npm run test:integration
  if ($LASTEXITCODE -ne 0) {
    Write-Host "FALLO en ejecución $i"
    exit 1
  }
}

Write-Host "`n=== US-001.5 VALIDADA ==="
```

### Resultado Esperado

```
Test Files  4 passed (4)        # +1 (message-flow rehabilitado)
     Tests  40 passed (40)      # +8 (los 8 tests de message-flow)
  Duration  ~70-90s
```

---

## Referencias

- **Test Original**: `backend/src/__tests__/integration/websocket/message-flow.integration.test.ts`
- **FakeAnthropicClient**: `backend/src/services/agent/FakeAnthropicClient.ts`
- **DirectAgentService**: `backend/src/services/agent/DirectAgentService.ts`
- **Config**: `backend/vitest.integration.config.ts`
- **PRD**: [PRD-INTEGRATION-TESTS.md](PRD-INTEGRATION-TESTS.md)
- **US-001**: [US-001-database-race-condition.md](US-001-database-race-condition.md)
