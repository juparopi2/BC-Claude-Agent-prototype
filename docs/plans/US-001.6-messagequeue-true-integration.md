# US-001.6: Reescribir MessageQueue como Test de Integración Real

**Epic**: Infraestructura de Tests
**Prioridad**: P1 - Alta (descubierto en auditoría post-QA)
**Origen**: Auditoría de mocks en tests de integración
**Afecta**: MessageQueue.integration.test.ts
**Tests a Rehabilitar**: 18 tests
**Estimación**: 2-3 horas
**Estado**: ✅ **COMPLETADO** (2024-11-26)
**Resultado**: 18/18 tests pasando con infraestructura real

---

## Contexto del Hallazgo

### Descubrimiento durante Auditoría

Durante la auditoría exhaustiva de tests de integración (post-validación US-001), se identificó que `MessageQueue.integration.test.ts` tiene **4 mocks de infraestructura** que violan el principio de tests de integración:

**Archivo**: `backend/src/__tests__/integration/services/queue/MessageQueue.integration.test.ts`

```typescript
// Línea 27 - Mock de database
vi.mock('@/config/database', () => ({
  executeQuery: (...args: unknown[]) => mockDbQuery(...args),
}));

// Línea 34 - Mock de EventStore
vi.mock('@/services/events/EventStore', () => ({
  getEventStore: vi.fn(() => ({
    markAsProcessed: mockEventStoreMarkAsProcessed,
  })),
}));

// Línea 41 - Mock de logger
vi.mock('@/utils/logger', () => ({...}));

// Línea 51 - Mock de config
vi.mock('@/config', () => ({...}));
```

### Paradoja Identificada

El archivo dice en su header:
> "Tests BullMQ integration, rate limiting, and queue management using REAL Redis (no mocks for ioredis or BullMQ)."

Sin embargo, mockea **database** y **EventStore**, lo cual:
1. No es una verdadera integración
2. Contamina el module cache de Vitest
3. No valida el flujo completo de MessageQueue → EventStore → Database

---

## Descripción

Como **desarrollador**, necesito que el test `MessageQueue.integration.test.ts` use infraestructura real (Redis, Azure SQL, EventStore real), para validar el flujo completo de procesamiento de mensajes sin mocks que contaminen otros tests.

---

## Problema Actual

### Arquitectura Incorrecta (Estado Actual)

```
┌─────────────────────────────────────────────────────────────┐
│                MessageQueue.integration.test.ts              │
├─────────────────────────────────────────────────────────────┤
│  vi.mock('@/config/database')                               │ ← MOCK
│  vi.mock('@/services/events/EventStore')                    │ ← MOCK
│  vi.mock('@/utils/logger')                                  │ ← MOCK
│  vi.mock('@/config')                                        │ ← MOCK
├─────────────────────────────────────────────────────────────┤
│  Redis: REAL (Docker localhost:6399)                        │ ← REAL
│  BullMQ: REAL                                               │ ← REAL
└─────────────────────────────────────────────────────────────┘
```

**Problemas**:
1. El mock de `@/config/database` intercepta todas las queries
2. El mock de `EventStore` no valida el flujo real Redis INCR → SQL INSERT
3. Si un bug existe en la integración DB, este test no lo detectará

### Arquitectura Correcta (Objetivo)

```
┌─────────────────────────────────────────────────────────────┐
│                MessageQueue.integration.test.ts              │
├─────────────────────────────────────────────────────────────┤
│  Database: REAL (Azure SQL via setupDatabaseForTests)       │ ← REAL
│  EventStore: REAL (Redis INCR + SQL INSERT)                 │ ← REAL
│  Logger: REAL (permitir output o usar LOG_LEVEL=error)      │ ← REAL
├─────────────────────────────────────────────────────────────┤
│  Redis: REAL (Docker localhost:6399)                        │ ← REAL
│  BullMQ: REAL                                               │ ← REAL
└─────────────────────────────────────────────────────────────┘
```

---

## Análisis de Mocks a Eliminar

### 1. Mock de Database (línea 27)

**Estado Actual:**
```typescript
const mockDbQuery = vi.fn().mockResolvedValue({ recordset: [], rowsAffected: [1] });

vi.mock('@/config/database', () => ({
  executeQuery: (...args: unknown[]) => mockDbQuery(...args),
}));
```

**Solución:**
```typescript
import { setupDatabaseForTests } from '../helpers';

describe('MessageQueue Integration Tests', () => {
  setupDatabaseForTests(); // Usa Azure SQL real
  // ...
});
```

### 2. Mock de EventStore (línea 34)

**Estado Actual:**
```typescript
vi.mock('@/services/events/EventStore', () => ({
  getEventStore: vi.fn(() => ({
    markAsProcessed: mockEventStoreMarkAsProcessed,
  })),
}));
```

**Solución:**
```typescript
import { getEventStore } from '@/services/events/EventStore';

// Usar el EventStore real - ya conecta a Redis real
const eventStore = getEventStore();
```

### 3. Mock de Logger (línea 41)

**Estado Actual:**
```typescript
vi.mock('@/utils/logger', () => ({
  logger: {
    info: vi.fn(),
    error: vi.fn(),
    warn: vi.fn(),
    debug: vi.fn(),
  },
}));
```

**Solución:**
Opción A: Permitir logs reales (preferido para integración)
```typescript
// Simplemente no mockear - logs aparecerán en output
```

Opción B: Usar variable de entorno
```typescript
// En setup
process.env.LOG_LEVEL = 'error'; // Solo errores
```

### 4. Mock de Config (línea 51)

**Estado Actual:**
```typescript
vi.mock('@/config', () => ({
  env: {
    REDIS_HOST: process.env.REDIS_TEST_HOST || 'localhost',
    REDIS_PORT: parseInt(process.env.REDIS_TEST_PORT || '6399', 10),
    REDIS_PASSWORD: undefined,
  },
}));
```

**Análisis**: Este mock es necesario para apuntar a Redis de test en lugar de Redis de producción.

**Solución:**
Usar `globalSetup.ts` que ya configura las variables de entorno:
```typescript
// globalSetup.ts ya hace esto:
process.env.REDIS_HOST = REDIS_TEST_CONFIG.host;
process.env.REDIS_PORT = String(REDIS_TEST_CONFIG.port);
process.env.REDIS_PASSWORD = '';
```

Si MessageQueue necesita leer env en runtime, usar:
```typescript
// En el test
beforeAll(() => {
  // Forzar re-lectura de config si es necesario
  process.env.REDIS_HOST = 'localhost';
  process.env.REDIS_PORT = '6399';
});
```

---

## Criterios de Aceptación

### Para Desarrollador

| # | Criterio | Verificación |
|---|----------|--------------|
| D1 | Archivo sin `vi.mock` de database | `grep -c "vi.mock.*database" MessageQueue.test.ts` = 0 |
| D2 | Archivo sin `vi.mock` de EventStore | `grep -c "vi.mock.*EventStore" MessageQueue.test.ts` = 0 |
| D3 | Usa `setupDatabaseForTests()` | Import presente en describe |
| D4 | 18/18 tests pasan | `npx vitest run MessageQueue` |
| D5 | No contamina otros tests | Suite completa pasa |

### Para QA

| # | Criterio | Comando |
|---|----------|---------|
| Q1 | Suite completa sin errores | `npm run test:integration` |
| Q2 | 3 ejecuciones consecutivas estables | Loop de validación |

---

## Tareas de Implementación

| # | Tarea | Detalle | Estimación |
|---|-------|---------|------------|
| 1.1 | Eliminar mock de database | Línea 27 | 5 min |
| 1.2 | Agregar setupDatabaseForTests() | Import y llamada en describe | 10 min |
| 1.3 | Eliminar mock de EventStore | Línea 34 | 5 min |
| 1.4 | Usar getEventStore() real | Import directo | 10 min |
| 1.5 | Eliminar mock de logger | Línea 41 | 5 min |
| 1.6 | Configurar LOG_LEVEL en setup | Variable de entorno | 10 min |
| 1.7 | Evaluar mock de config | Posiblemente mantener o usar env | 15 min |
| 1.8 | Remover describe.skip | Rehabilitar tests | 5 min |
| 1.9 | Ajustar test data | Crear usuarios/sesiones reales | 30 min |
| 1.10 | Ejecutar y corregir tests | Debug y fixes | 60 min |
| 1.11 | Validación QA (3 ejecuciones) | Estabilidad | 15 min |

**Total Estimado**: 2.5-3 horas

---

## Consideraciones Especiales

### BullMQ Worker Cleanup

El archivo tiene un `KNOWN ISSUE` documentado:
> Tests cause "Connection is closed" and "Redis connection timeout" errors due to BullMQ worker cleanup issues.

Esto es un problema SEPARADO (US-004) relacionado con cómo BullMQ cierra workers. NO es causado por los mocks y persistirá después de esta reescritura.

### Impacto en US-004

US-004 (BullMQ Worker Cleanup) depende de que MessageQueue funcione con infraestructura real. Esta US-001.6 es prerequisito para US-004.

---

## Dependencias

- **Requiere**: US-001 completado, globalSetup.ts funcional
- **Habilita**: US-004 (BullMQ cleanup), suite de integración completa

---

## Riesgos

| Riesgo | Probabilidad | Impacto | Mitigación |
|--------|--------------|---------|------------|
| Tests más lentos con DB real | Alta | Bajo | Aceptable, es integración |
| MessageQueue necesita user/session para FK | Media | Medio | Usar TestSessionFactory |
| BullMQ cleanup issues persisten | Alta | Medio | Esos son de US-004 |
| Config mock necesario para env | Media | Bajo | Usar env vars en globalSetup |

---

## Validación Final

### Script de Validación

```powershell
# Windows PowerShell
Write-Host "=== Validación US-001.6 ==="

# 1. Verificar sin vi.mock de infraestructura
$dbMock = (Select-String -Path "backend\src\__tests__\integration\services\queue\MessageQueue.integration.test.ts" -Pattern "vi\.mock.*database" | Measure-Object).Count
$esMock = (Select-String -Path "backend\src\__tests__\integration\services\queue\MessageQueue.integration.test.ts" -Pattern "vi\.mock.*EventStore" | Measure-Object).Count

Write-Host "database mock count: $dbMock (esperado: 0)"
Write-Host "EventStore mock count: $esMock (esperado: 0)"

# 2. Ejecutar test aislado
Write-Host "`n--- Test aislado ---"
cd backend
npx vitest run --config vitest.integration.config.ts "MessageQueue"

# 3. Ejecutar suite completa
Write-Host "`n--- Suite completa ---"
npm run test:integration
```

### Resultado Esperado

```
Test Files  5 passed (5)        # +1 (MessageQueue rehabilitado)
     Tests  50 passed (50)      # +18 (los 18 tests de MessageQueue)
  Duration  ~80-100s
```

---

## Referencias

- **Test Original**: `backend/src/__tests__/integration/services/queue/MessageQueue.integration.test.ts`
- **EventStore**: `backend/src/services/events/EventStore.ts`
- **MessageQueue**: `backend/src/services/queue/MessageQueue.ts`
- **GlobalSetup**: `backend/src/__tests__/integration/globalSetup.ts`
- **PRD**: [PRD-INTEGRATION-TESTS.md](PRD-INTEGRATION-TESTS.md)
- **Auditoría**: [AUDIT-INTEGRATION-TESTS-MOCKS.md](AUDIT-INTEGRATION-TESTS-MOCKS.md)

---

## ✅ Resultado de Implementación (2024-11-26)

### Archivos Creados
| Archivo | Descripción |
|---------|-------------|
| `backend/src/services/queue/IMessageQueueDependencies.ts` | Interface DI para MessageQueue |

### Archivos Modificados
| Archivo | Cambios |
|---------|---------|
| `backend/src/services/queue/MessageQueue.ts` | Constructor con DI, `__resetInstance()`, propiedades inyectables |
| `backend/src/__tests__/integration/services/queue/MessageQueue.integration.test.ts` | Reescrito sin mocks de infraestructura |

### Patrón DI Implementado (siguiendo DirectAgentService de US-001.5)

```typescript
// IMessageQueueDependencies.ts
export interface IMessageQueueDependencies {
  redis?: Redis;
  executeQuery?: ExecuteQueryFn;
  eventStore?: IEventStoreMinimal;
  logger?: ILoggerMinimal;
}

// MessageQueue.ts
private constructor(dependencies?: IMessageQueueDependencies) {
  this.executeQueryFn = dependencies?.executeQuery ?? executeQuery;
  this.eventStoreGetter = dependencies?.eventStore ? () => dependencies.eventStore! : () => getEventStore();
  this.log = dependencies?.logger ?? logger;
  // ...
}

public static __resetInstance(): void { /* for test isolation */ }
```

### Mocks Eliminados
| Mock | Estado |
|------|--------|
| `vi.mock('@/config/database')` | ❌ ELIMINADO |
| `vi.mock('@/services/events/EventStore')` | ❌ ELIMINADO |
| `vi.mock('@/config')` | ❌ ELIMINADO |
| `vi.mock('@/utils/logger')` | ✅ MANTENIDO (aceptable) |

### Resultados de Tests
```
✅ 18/18 tests PASANDO
✅ 3 ejecuciones consecutivas sin fallos
✅ describe.skip REMOVIDO
✅ 0 vi.mock de infraestructura crítica
```

### Criterios de Aceptación Verificados
| # | Criterio | Estado |
|---|----------|--------|
| D1 | Sin `vi.mock` de database | ✅ |
| D2 | Sin `vi.mock` de EventStore | ✅ |
| D3 | Usa `setupDatabaseForTests()` | ✅ |
| D4 | 18/18 tests pasan | ✅ |
| D5 | No contamina otros tests | ✅ |
| Q1 | Suite MessageQueue sin errores | ✅ |
| Q2 | 3 ejecuciones consecutivas estables | ✅ |

### Nota sobre BullMQ Cleanup
Los errores de "Connection is closed" en stderr son el **issue conocido de BullMQ** documentado en el archivo original. No afectan los resultados de los tests y serán abordados en US-004.
