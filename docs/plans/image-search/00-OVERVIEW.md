# Semantic Image Search - PRD

**Fecha**: 2026-01-06
**Estado**: Aprobado para Implementación
**Prioridad**: CRÍTICA (D2)
**Estimación**: 4-5 días

---

## Executive Summary

### Problema de Negocio

Un cliente vende cajas de metal personalizadas y piezas de camión. Tiene **10,000+ imágenes de productos** y necesita encontrar productos por concepto visual:

- "Muéstrame cajas metálicas similares a esta"
- "Busca acoplamientos de camión"
- "Encuentra productos con forma rectangular"

**Problema Actual**: Las imágenes se suben al sistema pero **NO son buscables**. El embedding de imagen se genera pero se pierde en el pipeline.

### Solución Propuesta

Implementar **Multimodal RAG** usando Azure Computer Vision Multimodal Embeddings:

1. **Imágenes y texto en el mismo espacio vectorial** (1024 dimensiones)
2. Usuario escribe query texto → se vectoriza → busca imágenes similares
3. Sin OCR, sin captions - solo similitud visual semántica

### ROI Esperado

| Métrica | Antes | Después |
|---------|-------|---------|
| Imágenes buscables | 0% | 100% |
| Tiempo de búsqueda manual | ~15 min | ~3 seg |
| Satisfacción cliente (NPS) | N/A | +40 puntos |

---

## Bug Crítico Identificado: Falso Positivo en Pipeline de Imágenes

### Descripción

Durante el análisis del código, se identificó un **bug crítico** que causa pérdida silenciosa de embeddings de imagen:

| Componente | Archivo | Línea | Comportamiento |
|------------|---------|-------|----------------|
| `ImageProcessor` | `processors/ImageProcessor.ts` | 134-141 | Genera embedding 1024d correctamente |
| `FileProcessingService` | `FileProcessingService.ts` | 179-198 | **NO persiste** el embedding, solo guarda `result.text` |
| `FileChunkingService` | `FileChunkingService.ts` | 114-128 | Marca `embedding_status='completed'` **sin indexar nada** |

### Código Problemático

```typescript
// FileChunkingService.ts - línea 114-128
if (IMAGE_MIME_TYPES.has(mimeType)) {
  logger.info(
    { fileId, userId, mimeType },
    'Skipping text chunking for image file - embedding already generated by ImageProcessor'
  );

  // ⚠️ BUG: Marca como "completed" pero el embedding NUNCA fue guardado
  await this.updateEmbeddingStatus(fileId, 'completed');  // FALSO POSITIVO

  return {
    fileId,
    chunkCount: 0,    // ⚠️ No hay chunks
    totalTokens: 0,   // ⚠️ No hay tokens
  };
  // ⚠️ El embedding de ImageProcessor se PIERDE aquí
}
```

### Impacto

1. **Usuario sube imagen** → Sistema procesa correctamente
2. **Azure Vision genera embedding** → 1024 dimensiones, costo incurrido
3. **Embedding se descarta** → No se guarda en BD ni en Azure AI Search
4. **Status muestra "completed"** → Usuario cree que imagen es buscable
5. **Búsqueda falla silenciosamente** → Imagen nunca aparece en resultados

### Causa Raíz

El comentario en el código dice *"embedding already generated by ImageProcessor"* pero:
- `ImageProcessor.extractText()` **retorna** el embedding en `result.metadata`
- `FileProcessingService.processFile()` **no lee** ese embedding
- `FileChunkingService` **asume** que ya fue guardado (incorrecto)

### Solución

Ver [01-TECHNICAL-SPEC.md](./01-TECHNICAL-SPEC.md) sección 2.1-2.3 para la corrección detallada.

---

## Arquitectura de Alto Nivel

```
┌──────────────────────────────────────────────────────────────────────┐
│                         UPLOAD FLOW                                   │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [Imagen JPEG/PNG]                                                    │
│         │                                                             │
│         ▼                                                             │
│  ┌─────────────────┐     ┌──────────────────┐     ┌───────────────┐ │
│  │ FileUpload      │────▶│ ImageProcessor   │────▶│ Azure Vision  │ │
│  │ Service         │     │ (extractText)    │     │ VectorizeImage│ │
│  └─────────────────┘     └──────────────────┘     └───────┬───────┘ │
│                                                           │          │
│                                     embedding 1024d ◀─────┘          │
│                                           │                          │
│                          ┌────────────────┴────────────────┐         │
│                          ▼                                 ▼         │
│                  ┌───────────────┐              ┌───────────────┐    │
│                  │ SQL Server    │              │ Azure AI      │    │
│                  │ image_embed.. │              │ Search Index  │    │
│                  └───────────────┘              └───────────────┘    │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────┐
│                         SEARCH FLOW                                   │
├──────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  [Query: "cajas metálicas"]                                           │
│         │                                                             │
│         ▼                                                             │
│  ┌─────────────────┐     ┌──────────────────┐     ┌───────────────┐ │
│  │ ImageSearch     │────▶│ EmbeddingService │────▶│ Azure Vision  │ │
│  │ Service         │     │ (generateQuery)  │     │ VectorizeText │ │
│  └─────────────────┘     └──────────────────┘     └───────┬───────┘ │
│                                                           │          │
│                                     embedding 1024d ◀─────┘          │
│                                           │                          │
│                                           ▼                          │
│                                   ┌───────────────┐                  │
│                                   │ Azure AI      │                  │
│                                   │ Search        │                  │
│                                   │ (cosine sim)  │                  │
│                                   └───────┬───────┘                  │
│                                           │                          │
│                                           ▼                          │
│                              [Resultados: Imágenes Similares]        │
│                                                                       │
└──────────────────────────────────────────────────────────────────────┘
```

---

## Principios de Implementación

### 1. Screaming Architecture

La estructura de carpetas debe "gritar" qué hace el sistema:

```
backend/src/
├── services/
│   ├── search/
│   │   ├── VectorSearchService.ts      # Búsqueda texto (existente)
│   │   ├── ImageSearchService.ts       # NUEVO: Búsqueda imágenes
│   │   ├── schema.ts                   # Actualizar con imageVector
│   │   └── types.ts                    # Actualizar con ImageSearchQuery
│   └── embeddings/
│       └── EmbeddingService.ts         # Agregar generateQueryEmbedding
```

### 2. Single Responsibility Principle (SRP)

| Componente | Responsabilidad Única |
|------------|----------------------|
| `ImageProcessor` | Extraer embedding de imagen (ya existe) |
| `ImageSearchService` | Buscar imágenes por query texto (NUEVO) |
| `EmbeddingService` | Generar embeddings (texto e imagen) |
| `VectorSearchService` | Indexar y buscar en Azure AI Search |

### 3. Multi-Tenant Security

**CRÍTICO**: Toda query DEBE filtrar por `userId`:

```typescript
// VectorSearchService.ts - línea ~180
const searchFilter = `userId eq '${userId}'`;  // OBLIGATORIO
```

### 4. Provider Agnostic

La solución usa Azure Vision hoy, pero debe permitir cambiar a:
- Google Cloud Vision
- AWS Rekognition
- OpenAI CLIP

```typescript
// Interface para abstracción futura
interface IImageEmbeddingProvider {
  generateImageEmbedding(buffer: Buffer): Promise<number[]>;
  generateTextEmbedding(text: string): Promise<number[]>;
  getDimensions(): number;
}
```

### 5. TDD (Test-Driven Development)

Cada componente tiene tests que se escriben ANTES del código:

```
backend/src/__tests__/
├── unit/
│   └── services/
│       └── search/
│           └── ImageSearchService.test.ts    # NUEVO
├── integration/
│   └── search/
│       └── ImageSearchService.integration.test.ts  # NUEVO
```

---

## Fases de Implementación

### Fase 1: Persistencia (1.5 días)

**Objetivo**: Guardar embeddings de imagen que hoy se pierden.

| Tarea | Archivo | Descripción |
|-------|---------|-------------|
| 1.1 | `migrations/00X-create-image-embeddings.sql` | Nueva tabla |
| 1.2 | `ImageProcessor.ts` | Retornar embedding en resultado |
| 1.3 | `FileProcessingService.ts` | Persistir embedding post-procesamiento |
| 1.4 | Tests unitarios | Verificar persistencia |

### Fase 2: Indexación (2 días)

**Objetivo**: Indexar embeddings en Azure AI Search para búsqueda.

| Tarea | Archivo | Descripción |
|-------|---------|-------------|
| 2.1 | `schema.ts` | Agregar campo `imageVector` 1024d |
| 2.2 | `VectorSearchService.ts` | Método `indexImageEmbedding` |
| 2.3 | `ImageSearchService.ts` | Nuevo servicio de búsqueda |
| 2.4 | Tests integración | Verificar indexación y búsqueda |

### Fase 3: Query (1 día)

**Objetivo**: Exponer búsqueda via API y WebSocket.

| Tarea | Archivo | Descripción |
|-------|---------|-------------|
| 3.1 | `EmbeddingService.ts` | Método `generateQueryEmbedding` |
| 3.2 | `routes/files.routes.ts` | Endpoint `GET /api/files/search/images` |
| 3.3 | RAG Agent integration | Herramienta `search_images` |
| 3.4 | Tests E2E | Flujo completo |

---

## Archivos Afectados

### Modificaciones

| Archivo | Cambio |
|---------|--------|
| `backend/src/services/files/processors/ImageProcessor.ts` | Retornar embedding en `ExtractionResult` |
| `backend/src/services/files/FileProcessingService.ts` | Persistir embedding después de extracción |
| `backend/src/services/search/schema.ts` | Agregar `imageVector` field 1024d |
| `backend/src/services/search/VectorSearchService.ts` | Métodos `indexImageEmbedding`, `searchImages` |
| `backend/src/services/embeddings/EmbeddingService.ts` | Método `generateQueryEmbedding` |
| `backend/src/routes/files.routes.ts` | Endpoint de búsqueda de imágenes |

### Nuevos Archivos

| Archivo | Descripción |
|---------|-------------|
| `backend/migrations/00X-create-image-embeddings.sql` | Tabla `image_embeddings` |
| `backend/src/services/search/ImageSearchService.ts` | Servicio de búsqueda de imágenes |
| `backend/src/services/search/image/types.ts` | Tipos para búsqueda de imágenes |
| `backend/src/__tests__/unit/services/search/ImageSearchService.test.ts` | Tests unitarios |
| `backend/src/__tests__/integration/search/ImageSearchService.integration.test.ts` | Tests integración |

---

## Riesgos y Mitigaciones

| Riesgo | Probabilidad | Impacto | Mitigación |
|--------|--------------|---------|------------|
| Azure Vision rate limits | Media | Alto | Implementar retry con backoff |
| Índice muy grande (>100K imágenes) | Baja | Medio | Particionar por userId si necesario |
| Embeddings incompatibles post-update | Baja | Alto | Versionar embeddings, re-indexar si cambia modelo |
| Query text no encuentra resultados | Media | Medio | Fallback a búsqueda híbrida text+visual |

---

## Métricas de Éxito

| Métrica | Target | Medición |
|---------|--------|----------|
| Latencia búsqueda P95 | < 500ms | Application Insights |
| Precisión top-5 | > 80% | Test manual con dataset conocido |
| Cobertura de tests | > 90% | Jest coverage |
| Zero data leaks | 0 | Security audit |

---

## Documentos Relacionados

- [01-TECHNICAL-SPEC.md](./01-TECHNICAL-SPEC.md) - Especificación técnica detallada
- [02-DATABASE-SCHEMA.md](./02-DATABASE-SCHEMA.md) - Migraciones y schema SQL
- [03-AZURE-SEARCH-SCHEMA.md](./03-AZURE-SEARCH-SCHEMA.md) - Configuración Azure AI Search
- [04-TEST-SPEC.md](./04-TEST-SPEC.md) - Especificaciones TDD

---

## Aprobaciones

| Rol | Nombre | Fecha |
|-----|--------|-------|
| Tech Lead | [Pendiente] | |
| Product Owner | [Pendiente] | |
| Security | [Pendiente] | |
